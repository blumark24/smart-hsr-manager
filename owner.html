
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ â€“ SmartX Elite v2</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root {
      /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ (Light) */
      --bg: #f5f7fa;            /* Ø®Ù„ÙÙŠØ© Ø¹Ø§Ù…Ø© */
      --text: #0b1220;          /* Ù„ÙˆÙ† Ù†Øµ Ø£Ø³Ø§Ø³ÙŠ */
      --muted: #5b6b84;         /* Ù†Øµ Ø«Ø§Ù†ÙˆÙŠ */
      --card: #ffffff;          /* Ø¨Ø·Ø§Ù‚Ø§Øª */
      --stroke: #e6ecf3;        /* Ø­Ø¯ÙˆØ¯ */
      --chip: #eef3f9;          /* Ø´Ø§Ø±Ø§Øª */
      --primary: #0a2647;       /* ÙƒØ­Ù„ÙŠ Ø§Ù„Ù‡ÙˆÙŠØ© */
      --gold: #ffd700;          /* Ø°Ù‡Ø¨ÙŠ */
      --emerald: #10b981;       /* Ø²Ù…Ø±Ø¯ÙŠ */
      --cyan: #06b6d4;          /* Ø³Ù…Ø§ÙˆÙŠ */
      --amber: #f59e0b;         /* Ø°Ù‡Ø¨ÙŠ ØªØ­Ø°ÙŠØ± */
      --rose: #f43f5e;          /* Ø£Ø­Ù…Ø± */
    }
    :root[data-theme="dark"] {
      /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (Dark) */
      --bg:#0a2647; --text:#f8fafc; --muted:#94a3b8; --card:#0f284f; --stroke:#1c325c; --chip:#0b1f3f;
      --primary:#0a2647; --gold:#ffd700; --emerald:#10b981; --cyan:#06b6d4; --amber:#f59e0b; --rose:#f43f5e;
    }
    html, body { height:100%; }
    body { background: var(--bg); color: var(--text); font-family:"Cairo", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .card { border:1px solid var(--stroke); border-radius: 16px; background: var(--card); box-shadow: 0 8px 24px rgba(2,6,23,.06); }
    .title { color: var(--gold); letter-spacing:.2px; }
    .pill { padding:.2rem .6rem; border:1px solid var(--stroke); border-radius:999px; font-size:12px; background: var(--chip); color: var(--muted); }
    .btn { border-radius: 12px; padding:.6rem 1rem; font-weight:700; transition: .2s; }
    .btn-outline { border:1px solid var(--stroke); background: transparent; }
    .btn-primary { background: linear-gradient(135deg, #059669, var(--emerald)); color:#fff; border:1px solid #059669; }
    .btn-warn { background: linear-gradient(135deg, #f97316, var(--amber)); color:#000; border:1px solid #f59e0b; }
    .btn-ghost { background: transparent; }
    .sidebar-link { border-radius: 12px; padding:.65rem .8rem; display:flex; align-items:center; gap:.6rem; border:1px solid transparent; color: var(--text); }
    .sidebar-link:hover { background: var(--chip); border-color: var(--stroke); }
    .table { border-collapse: separate; border-spacing:0; width:100%; }
    .table th, .table td { border-bottom:1px solid var(--stroke); padding:.75rem .75rem; }
    .kpi { position:relative; overflow:hidden; }
    .kpi:after { content:""; position:absolute; inset:0; background: radial-gradient(120px 120px at 100% -10%, rgba(255,215,0,.16), transparent 60%); pointer-events:none; }
    .badge { border-radius:999px; padding:.2rem .55rem; font-size:12px; border:1px solid var(--stroke); background: var(--chip); }
    .muted { color: var(--muted); }
    .notif { border-left: 3px solid var(--emerald); }
    .switch { inline-size: 44px; block-size: 26px; border-radius:999px; background: var(--chip); border:1px solid var(--stroke); position:relative; }
    .switch i { position:absolute; inset-block-start:2px; inset-inline-start:2px; inline-size:22px; block-size:22px; background:#fff; border-radius:999px; transition:.25s; box-shadow:0 2px 6px rgba(0,0,0,.15); }
    [data-theme="dark"] .switch i { transform: translateX(18px); }
  </style>
</head>
<body class="min-h-screen">
  <div class="grid grid-cols-12 gap-4 p-4">
    <!-- Sidebar -->
    <aside class="col-span-12 md:col-span-3 lg:col-span-2 card p-4">
      <div class="flex items-center gap-3 mb-6">
        <div style="background:linear-gradient(135deg, var(--emerald), var(--cyan))" class="w-10 h-10 rounded-2xl grid place-items-center font-extrabold text-white">SX</div>
        <div>
          <div class="text-xs muted">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</div>
          <div class="font-bold">SmartX Elite</div>
        </div>
      </div>
      <nav class="space-y-1 text-sm">
        <a class="sidebar-link" href="#dashboard">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <a class="sidebar-link" href="#orgs">ğŸ¢ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª</a>
        <a class="sidebar-link" href="#invoices">ğŸ’³ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</a>
        <a class="sidebar-link" href="#analytics">ğŸ“ˆ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</a>
        <a class="sidebar-link" href="#settings">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="col-span-12 md:col-span-9 lg:col-span-10 space-y-4">
      <!-- Topbar -->
      <header class="card px-4 py-3 flex items-center justify-between">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ â€“ ØªØ­ÙƒÙ… Ø´Ø§Ù…Ù„ Ø¨Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª</h1>
          <p class="muted text-sm mt-1">ØªØµÙ…ÙŠÙ… ÙØ®Ù… Ø¨Ù‡ÙˆÙŠØ© Ø±Ø³Ù…ÙŠØ© + ÙˆØ¶Ø¹ Ù†Ù‡Ø§Ø±ÙŠ/Ù„ÙŠÙ„ÙŠ + ÙÙˆØ§ØªÙŠØ± Ø§Ø­ØªØ±Ø§ÙÙŠØ©.</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <span id="themeLabel" class="muted text-xs">Ù†Ù‡Ø§Ø±ÙŠ</span>
            <button id="themeToggle" class="switch" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹"><i></i></button>
          </div>
          <span class="pill">ğŸ‘‘ Ù…Ø±Ø­Ù‘Ø¨Ù‹Ø§ Ø¨Ùƒ Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…</span>
          <button id="logoutBtn" class="btn btn-outline">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      </header>

      <!-- Notifications -->
      <section id="notifications" class="hidden card px-4 py-3 notif">
        <div class="flex items-start gap-3">
          <div>ğŸ””</div>
          <div>
            <div class="font-bold">ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø§Ù„ÙŠ</div>
            <div id="notifText" class="muted text-sm">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø£ÙŠ ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯ (ÙØ§ØªÙˆØ±Ø© ØµØ¯Ø±ØªØŒ Ø§Ø´ØªØ±Ø§Ùƒ Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ØŒ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯).</div>
          </div>
          <div class="ms-auto"><button id="hideNotif" class="btn btn-ghost">Ø¥Ø®ÙØ§Ø¡</button></div>
        </div>
      </section>

      <!-- KPI Cards -->
      <section id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
        <div class="card p-4 kpi">
          <p class="text-xs muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</p>
          <h3 id="kpiRevenue" class="text-3xl font-extrabold" style="color:var(--emerald)">--</h3>
          <small id="kpiRevenueNote" class="muted">â€”</small>
        </div>
        <div class="card p-4 kpi">
          <p class="text-xs muted">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</p>
          <h3 id="kpiActive" class="text-3xl font-extrabold" style="color:var(--cyan)">--</h3>
          <small class="muted">Ø®Ø·Ø© Ù…Ø¯ÙÙˆØ¹Ø©</small>
        </div>
        <div class="card p-4 kpi">
          <p class="text-xs muted">Ø§Ù„ØªØ¬Ø§Ø±Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</p>
          <h3 id="kpiTrial" class="text-3xl font-extrabold" style="color:var(--amber)">--</h3>
          <small class="muted">ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ù‹Ø§</small>
        </div>
        <div class="card p-4 kpi">
          <p class="text-xs muted">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ù†ØªÙ‡ÙŠØ©</p>
          <h3 id="kpiExpired" class="text-3xl font-extrabold" style="color:var(--rose)">--</h3>
          <small class="muted">Ø¨Ø­Ø§Ø¬Ø© Ù…ØªØ§Ø¨Ø¹Ø©</small>
        </div>
      </section>

      <!-- Charts -->
      <section id="analytics" class="grid grid-cols-1 xl:grid-cols-3 gap-4">
        <div class="card p-4 xl:col-span-2">
          <div class="flex items-center justify-between mb-2"><h2 class="text-lg font-bold title">Ù†Ù…Ùˆ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª (6 Ø£Ø´Ù‡Ø±)</h2><span class="pill">ØªÙØ§Ø¹Ù„ÙŠ</span></div>
          <canvas id="orgsChart" height="80"></canvas>
        </div>
        <div class="card p-4">
          <h2 class="text-lg font-bold title mb-2">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø®Ø·Ø·</h2>
          <canvas id="plansChart" height="80"></canvas>
        </div>
      </section>

      <!-- Organizations Table -->
      <section id="orgs" class="card p-4">
        <div class="flex items-center justify-between flex-wrap gap-2 mb-3">
          <div>
            <h2 class="text-lg font-bold title">Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h2>
            <p class="text-xs muted">Ø¥Ø¯Ø§Ø±Ø© ÙƒØ§Ù…Ù„Ø©: Ø¥Ø¶Ø§ÙØ©ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ø°ÙØŒ ÙˆØªØ±Ù‚ÙŠØ© Ø§Ù„Ø®Ø·Ø· (ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ±Ù‚ÙŠØ©).</p>
          </div>
          <div class="flex items-center gap-2">
            <input id="searchBox" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©..." class="bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-[var(--emerald)]" />
            <button id="addOrgBtn" class="btn btn-primary">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø³Ø³Ø©</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="table text-sm text-right">
            <thead class="muted">
              <tr>
                <th>Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</th><th>Ø§Ù„Ù…Ø¯ÙŠØ±</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                <th>Ø§Ù„Ø®Ø·Ø©</th><th>Ø§Ù„Ø¯ÙˆØ±Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="orgsBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Invoices -->
      <section id="invoices" class="card p-4">
        <div class="flex items-center justify-between flex-wrap gap-2 mb-3">
          <div>
            <h2 class="text-lg font-bold title">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
            <p class="text-xs muted">ÙÙˆØ§ØªÙŠØ± Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª (Ø¥Ù†Ø´Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ù‘Ø§).</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="newInvoiceBtn" class="btn btn-outline">+ Ø¥ØµØ¯Ø§Ø± ÙØ§ØªÙˆØ±Ø© ÙŠØ¯ÙˆÙŠØ©</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="table text-sm text-right">
            <thead class="muted">
              <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</th><th>Ø§Ù„Ø®Ø·Ø©</th><th>Ø§Ù„Ø¯ÙˆØ±Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ù…Ù„Ù</th>
              </tr>
            </thead>
            <tbody id="invoicesBody"></tbody>
          </table>
        </div>
      </section>

      <footer id="settings" class="text-xs muted py-4">
        <p>Â© SmartX Elite â€“ Ù„ÙˆØ­Ø© Ù…Ø§Ù„Ùƒ ÙØ§Ø®Ø±Ø© Ø¨Ù…Ø³ØªÙˆÙ‰ Ø¹Ø§Ù„Ù…ÙŠ. Ø§Ù„ÙˆØ¶Ø¹ <span id="modeText">Ù†Ù‡Ø§Ø±ÙŠ</span>.</p>
      </footer>
    </main>
  </div>

  <!-- Modal: Add/Edit Organization -->
  <dialog id="orgModal" class="card p-0 w-[92vw] max-w-2xl">
    <form id="orgForm" method="dialog" class="p-4 space-y-3">
      <div class="flex items-center justify-between mb-2">
        <h3 id="modalTitle" class="text-xl font-extrabold title">Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø³Ø³Ø©</h3>
        <button type="button" onclick="document.getElementById('orgModal').close()" class="pill">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <label class="text-sm">Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©<input name="name" required class="w-full bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 mt-1" /></label>
        <label class="text-sm">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±<input name="manager" required class="w-full bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 mt-1" /></label>
        <label class="text-sm">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ<input name="email" type="email" required class="w-full bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 mt-1" /></label>
        <label class="text-sm">Ø§Ù„Ø¬ÙˆØ§Ù„<input name="phone" required class="w-full bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 mt-1" /></label>
        <label class="text-sm">Ø§Ù„Ø®Ø·Ø©<select name="plan" class="w-full bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 mt-1"><option>Trial</option><option>Basic</option><option>Pro</option><option>Enterprise</option></select></label>
        <label class="text-sm">Ø§Ù„Ø¯ÙˆØ±Ø©<select name="billingCycle" class="w-full bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 mt-1"><option>monthly</option><option>yearly</option></select></label>
        <label class="text-sm">Ø§Ù„Ø­Ø§Ù„Ø©<select name="status" class="w-full bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 mt-1"><option>active</option><option>expired</option><option>trial</option></select></label>
        <label class="text-sm">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡<input name="expiresAt" type="date" required class="w-full bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 mt-1" /></label>
      </div>
      <div class="flex items-center gap-2 justify-end pt-2">
        <button id="deleteBtn" type="button" class="btn btn-outline hidden">Ø­Ø°Ù</button>
        <button id="saveBtn" class="btn btn-primary" value="default">Ø­ÙØ¸</button>
      </div>
      <input type="hidden" name="docId" />
    </form>
  </dialog>

  <!-- Modal: Manual Invoice -->
  <dialog id="invoiceModal" class="card p-0 w-[92vw] max-w-xl">
    <form id="invoiceForm" method="dialog" class="p-4 space-y-3">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-xl font-extrabold title">Ø¥ØµØ¯Ø§Ø± ÙØ§ØªÙˆØ±Ø© ÙŠØ¯ÙˆÙŠØ©</h3>
        <button type="button" onclick="document.getElementById('invoiceModal').close()" class="pill">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <label class="text-sm">Ø§Ù„Ù…Ø¤Ø³Ø³Ø©<select name="orgId" id="invoiceOrgId" class="w-full bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 mt-1"></select></label>
        <label class="text-sm">Ø§Ù„Ø®Ø·Ø©<select name="plan" class="w-full bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 mt-1"><option>Basic</option><option>Pro</option><option>Enterprise</option></select></label>
        <label class="text-sm">Ø§Ù„Ø¯ÙˆØ±Ø©<select name="billingCycle" class="w-full bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 mt-1"><option>monthly</option><option>yearly</option></select></label>
        <label class="text-sm">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©)<input name="amount" type="number" min="0" step="0.01" class="w-full bg-transparent border border-[var(--stroke)] rounded-xl px-3 py-2 mt-1" placeholder="Ù…Ø«Ø§Ù„: 499" /></label>
      </div>
      <div class="flex items-center gap-2 justify-end pt-2">
        <button class="btn btn-primary" value="default">Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    // âœ… Ø§ØªØµØ§Ù„ ÙØ¹Ù„ÙŠ Ø¨Ù€ Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXCiNeaO9lhM79tKb98x4oaNqNy5xKvWM",
      authDomain: "smart-hsr-manager.firebaseapp.com",
      projectId: "smart-hsr-manager",
      storageBucket: "smart-hsr-manager.firebasestorage.app",
      messagingSenderId: "38965508031",
      appId: "1:38965508031:web:6fd0b6c6b0b63fa513930a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const orgsBody = document.getElementById('orgsBody');
    const invoicesBody = document.getElementById('invoicesBody');
    const searchBox = document.getElementById('searchBox');
    const addOrgBtn = document.getElementById('addOrgBtn');
    const newInvoiceBtn = document.getElementById('newInvoiceBtn');
    const kpiRevenue = document.getElementById('kpiRevenue');
    const kpiRevenueNote = document.getElementById('kpiRevenueNote');
    const kpiActive = document.getElementById('kpiActive');
    const kpiTrial = document.getElementById('kpiTrial');
    const kpiExpired = document.getElementById('kpiExpired');

    const notif = document.getElementById('notifications');
    const notifText = document.getElementById('notifText');
    const hideNotif = document.getElementById('hideNotif');

    // Ù…ÙˆØ¯Ø§Ù„Ø§Øª
    const orgModal = document.getElementById('orgModal');
    const orgForm = document.getElementById('orgForm');
    const modalTitle = document.getElementById('modalTitle');
    const deleteBtn = document.getElementById('deleteBtn');

    const invoiceModal = document.getElementById('invoiceModal');
    const invoiceForm = document.getElementById('invoiceForm');
    const invoiceOrgSelect = document.getElementById('invoiceOrgId');

    // Ø«ÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø±/Ø§Ù„Ù„ÙŠÙ„
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const modeText = document.getElementById('modeText');

    function applyTheme(mode){
      document.documentElement.setAttribute('data-theme', mode);
      const isDark = mode === 'dark';
      themeLabel.textContent = isDark ? 'Ù„ÙŠÙ„ÙŠ' : 'Ù†Ù‡Ø§Ø±ÙŠ';
      modeText.textContent = isDark ? 'Ù„ÙŠÙ„ÙŠ' : 'Ù†Ù‡Ø§Ø±ÙŠ';
      localStorage.setItem('smartx_theme', mode);
    }
    const savedTheme = localStorage.getItem('smartx_theme') || 'dark';
    applyTheme(savedTheme);
    themeToggle.addEventListener('click', ()=> applyTheme(document.documentElement.getAttribute('data-theme')==='dark' ? 'light' : 'dark'));

    // Ø¨ÙŠØ§Ù†Ø§Øª
    let ORGS = [];
    let INVOICES = [];

    function formatSAR(n){ return new Intl.NumberFormat('ar-SA', {minimumFractionDigits:2, maximumFractionDigits:2}).format(n) + ' Ø±.Ø³'; }

    async function fetchOrganizations(){
      const q = query(collection(db, 'organizations'), orderBy('createdAt', 'desc'));
      const snap = await getDocs(q);
      ORGS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderOrgs();
      renderKPIs();
      renderCharts();
      fillInvoiceOrgSelect();
    }

    async function fetchInvoices(){
      const q = query(collection(db, 'invoices'), orderBy('createdAt', 'desc'));
      const snap = await getDocs(q);
      INVOICES = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderInvoices();
    }

    function renderKPIs(){
      const active = ORGS.filter(o => o.plan && o.plan !== 'Trial' && (o.status||'active') === 'active').length;
      const trial = ORGS.filter(o => (o.plan === 'Trial' || (o.status||'') === 'trial')).length;
      const expired = ORGS.filter(o => (o.status||'') === 'expired').length;
      const revenue = INVOICES.filter(i=> (i.status||'')==='paid')
        .reduce((sum,i)=> sum + (i.total || 0), 0);
      kpiActive.textContent = active; kpiTrial.textContent = trial; kpiExpired.textContent = expired; kpiRevenue.textContent = formatSAR(revenue);
      kpiRevenueNote.textContent = revenue? 'Ø¥ÙŠØ±Ø§Ø¯ Ù…Ø¯ÙÙˆØ¹ Ø®Ù„Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ù† Ø§Ù„ÙÙˆØ§ØªÙŠØ±)': 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§';
    }

    function renderOrgs(filter=''){
      const rows = (filter? ORGS.filter(o=> (o.name||'').includes(filter)) : ORGS)
        .map(o=>`<tr>
          <td class="font-semibold">${o.name||'-'}</td>
          <td>${o.manager||'-'}</td>
          <td>${o.email||'-'}</td>
          <td>${o.phone||'-'}</td>
          <td><span class="badge">${o.plan||'Trial'}</span></td>
          <td>${o.billingCycle||'monthly'}</td>
          <td>${o.status||'active'}</td>
          <td>${o.expiresAt? new Date(o.expiresAt).toLocaleDateString('ar-SA'): '-'}</td>
          <td>
            <div class="flex gap-2">
              <button class="btn btn-outline" data-act="edit" data-id="${o.id}">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn btn-primary" data-act="upgrade" data-id="${o.id}">ØªØ±Ù‚ÙŠØ©</button>
              <button class="btn btn-outline" data-act="delete" data-id="${o.id}">Ø­Ø°Ù</button>
            </div>
          </td>
        </tr>`).join('');
      orgsBody.innerHTML = rows || `<tr><td colspan="9" class="text-center muted py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¤Ø³Ø³Ø§Øª Ø¨Ø¹Ø¯</td></tr>`;
    }

    function fillInvoiceOrgSelect(){
      invoiceOrgSelect.innerHTML = ORGS.map(o=>`<option value="${o.id}">${o.name||o.id}</option>`).join('');
    }

    function renderInvoices(){
      invoicesBody.innerHTML = INVOICES.map(inv=>`
        <tr>
          <td>${inv.invoiceId||inv.id}</td>
          <td>${inv.organization_name||'-'}</td>
          <td>${inv.plan||'-'}</td>
          <td>${inv.billingCycle||'-'}</td>
          <td>${formatSAR(inv.total||0)}</td>
          <td><span class="badge" style="border-color:${(inv.status==='paid')?'#16a34a':'#f59e0b'}; color:${(inv.status==='paid')?'#16a34a':'#f59e0b'}">${inv.status||'-'}</span></td>
          <td>${inv.createdAt? new Date(inv.createdAt).toLocaleDateString('ar-SA'):'-'}</td>
          <td><button class="btn btn-outline" data-dl="${inv.id}">PDF</button></td>
        </tr>`).join('');
    }

    // Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ©
    let lineChart, pieChart;
    function renderCharts(){
      // Ø®Ø·ÙŠ: Ù†Ù…Ùˆ Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª
      const byMonth = Array.from({length:6}).map(()=>0);
      const now = new Date();
      ORGS.forEach(o=>{ const d = o.createdAt? new Date(o.createdAt): null; if(!d) return; const diff = (now.getMonth()-d.getMonth()+12)%12; if(diff<6) byMonth[5-diff]++;});
      const labels = Array.from({length:6}).map((_,i)=> new Date(now.getFullYear(), now.getMonth()-(5-i)).toLocaleDateString('ar-SA',{month:'long'}));
      const ctx1 = document.getElementById('orgsChart'); lineChart && lineChart.destroy();
      lineChart = new Chart(ctx1,{ type:'line', data:{ labels, datasets:[{ label:'Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', data:byMonth, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,.2)', borderWidth:3, tension:.35, fill:true }]}, options:{ plugins:{ legend:{ labels:{ color:'var(--muted)'} } }, scales:{ x:{ ticks:{ color:'var(--muted)'} }, y:{ ticks:{ color:'var(--muted)'} } } }});

      // Ø¯Ø§Ø¦Ø±ÙŠ: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø®Ø·Ø·
      const plans = {Trial:0,Basic:0,Pro:0,Enterprise:0};
      ORGS.forEach(o=>{ plans[o.plan||'Trial'] = (plans[o.plan||'Trial']||0)+1; });
      const ctx2 = document.getElementById('plansChart'); pieChart && pieChart.destroy();
      pieChart = new Chart(ctx2, { type:'doughnut', data:{ labels:Object.keys(plans), datasets:[{ data:Object.values(plans) }] }, options:{ plugins:{ legend:{ labels:{ color:'var(--muted)'} } } } });
    }

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¬Ø¯ÙˆÙ„
    orgsBody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const act = btn.dataset.act; const id = btn.dataset.id; const org = ORGS.find(o=>o.id===id);
      if(act==='edit'){ openOrgModal(org); }
      if(act==='upgrade'){ // ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø®Ø·Ø© â†’ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø³Ø³Ø© + Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©
        const newPlan = org.plan==='Pro' ? 'Enterprise' : (org.plan==='Basic' ? 'Pro' : 'Pro');
        await updateDoc(doc(db,'organizations', id), { plan:newPlan, status:'active', updatedAt: serverTimestamp() });
        await createInvoice({ org, plan:newPlan, billingCycle: org.billingCycle||'monthly' });
        showNotif(`ØªÙ…Øª ØªØ±Ù‚ÙŠØ© Ø®Ø·Ø© ${org.name} Ø¥Ù„Ù‰ ${newPlan} ÙˆØ¥ØµØ¯Ø§Ø± ÙØ§ØªÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.`);
        await refreshAll();
      }
      if(act==='delete'){
        if(confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø¤Ø³Ø³Ø©ØŸ')){ await deleteDoc(doc(db,'organizations', id)); showNotif('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­.'); await refreshAll(); }
      }
    });

    // Ø¨Ø­Ø«
    searchBox.addEventListener('input', (e)=> renderOrgs(e.target.value.trim()));

    // Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©
    addOrgBtn.addEventListener('click', ()=> openOrgModal());
    function openOrgModal(org=null){
      orgForm.reset();
      document.getElementById('modalTitle').textContent = org? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¤Ø³Ø³Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø³Ø³Ø©';
      const f = orgForm.elements;
      f.name.value = org?.name||''; f.manager.value = org?.manager||''; f.email.value = org?.email||''; f.phone.value = org?.phone||'';
      f.plan.value = org?.plan||'Trial'; f.billingCycle.value = org?.billingCycle||'monthly'; f.status.value = org?.status|| (org?.plan==='Trial'?'trial':'active');
      f.expiresAt.value = org?.expiresAt? new Date(org.expiresAt).toISOString().slice(0,10): '';
      f.docId.value = org?.id||''; deleteBtn.classList.toggle('hidden', !org);
      orgModal.showModal();
    }

    orgForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); const f = orgForm.elements;
      const payload = {
        name:f.name.value.trim(), manager:f.manager.value.trim(), email:f.email.value.trim(), phone:f.phone.value.trim(),
        plan:f.plan.value, billingCycle:f.billingCycle.value, status:f.status.value,
        expiresAt: f.expiresAt.value ? new Date(f.expiresAt.value).toISOString() : null,
        createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      };
      const id = f.docId.value;
      if(id){ await updateDoc(doc(db,'organizations', id), payload); showNotif('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø©.'); }
      else { const ref = await addDoc(collection(db,'organizations'), payload); showNotif('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø³Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­.'); }
      orgModal.close(); await refreshAll();
    });
    deleteBtn.addEventListener('click', async ()=>{
      const id = orgForm.elements.docId.value; if(!id) return;
      if(confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')){ await deleteDoc(doc(db,'organizations', id)); orgModal.close(); showNotif('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¤Ø³Ø³Ø©.'); await refreshAll(); }
    });

    // Ù…ÙˆØ¯Ø§Ù„ ÙØ§ØªÙˆØ±Ø© ÙŠØ¯ÙˆÙŠØ©
    newInvoiceBtn.addEventListener('click', ()=> { invoiceForm.reset(); fillInvoiceOrgSelect(); invoiceModal.showModal(); });
    invoiceForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); const f = invoiceForm.elements;
      const org = ORGS.find(o=>o.id===f.orgId.value); if(!org) return;
      await createInvoice({ org, plan:f.plan.value, billingCycle:f.billingCycle.value, amount: Number(f.amount.value||0) });
      invoiceModal.close(); showNotif('ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„.'); await refreshAll();
    });

    // Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© + Ø­ÙØ¸ PDF
    async function createInvoice({ org, plan, billingCycle, amount }){
      // ØªØ³Ø¹ÙŠØ± Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠÙØ±Ø³Ù„ Ù…Ø¨Ù„Øº ÙŠØ¯ÙˆÙŠ
      const base = amount || (plan==='Basic'?249: plan==='Pro'?499: 1499);
      const vat = +(base * 0.15).toFixed(2);
      const total = +(base + vat).toFixed(2);
      const invoiceId = 'INV-' + Math.random().toString(36).slice(2,7).toUpperCase();
      const payload = {
        invoiceId,
        organization_id: org.id,
        organization_name: org.name,
        plan, billingCycle,
        amount: base, vat, total,
        status: 'paid', // Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ Ù…Ø¯ÙÙˆØ¹Ø© â€“ ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹
        createdAt: new Date().toISOString()
      };
      await addDoc(collection(db,'invoices'), payload);
      // ØªÙˆÙ„ÙŠØ¯ PDF Ø¨Ø³ÙŠØ·
      const { jsPDF } = window.jspdf; const docPdf = new jsPDF({ unit:'pt', compress:true });
      docPdf.setFont('helvetica','bold'); docPdf.setFontSize(16);
      docPdf.text(`ÙØ§ØªÙˆØ±Ø© Ø§Ø´ØªØ±Ø§Ùƒ â€“ ${invoiceId}` , 40, 40);
      docPdf.setFontSize(12); docPdf.setFont('helvetica','normal');
      docPdf.text(`Ø§Ù„Ù…Ø¤Ø³Ø³Ø©: ${org.name||'-'}`, 40, 70);
      docPdf.text(`Ø§Ù„Ø®Ø·Ø©: ${plan} (${billingCycle})`, 40, 90);
      docPdf.text(`Ø§Ù„Ù…Ø¨Ù„Øº: ${base} SAR`, 40, 110);
      docPdf.text(`Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© 15%: ${vat} SAR`, 40, 130);
      docPdf.text(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} SAR`, 40, 150);
      docPdf.text(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${(new Date()).toLocaleDateString('ar-SA')}`, 40, 170);
      docPdf.save(`${invoiceId}.pdf`);
    }

    // ØªÙ†Ø²ÙŠÙ„ PDF Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ø³Ø±ÙŠØ¹)
    invoicesBody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.dl; if(!id) return;
      const inv = INVOICES.find(x=> x.id===id); if(!inv) return;
      const { jsPDF } = window.jspdf; const docPdf = new jsPDF({ unit:'pt', compress:true });
      docPdf.setFont('helvetica','bold'); docPdf.setFontSize(16);
      docPdf.text(`ÙØ§ØªÙˆØ±Ø© Ø§Ø´ØªØ±Ø§Ùƒ â€“ ${inv.invoiceId||id}` , 40, 40);
      docPdf.setFontSize(12); docPdf.setFont('helvetica','normal');
      docPdf.text(`Ø§Ù„Ù…Ø¤Ø³Ø³Ø©: ${inv.organization_name||'-'}`, 40, 70);
      docPdf.text(`Ø§Ù„Ø®Ø·Ø©: ${inv.plan||'-'} (${inv.billingCycle||'-'})`, 40, 90);
      docPdf.text(`Ø§Ù„Ù…Ø¨Ù„Øº: ${inv.amount||0} SAR`, 40, 110);
      docPdf.text(`Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© 15%: ${inv.vat||0} SAR`, 40, 130);
      docPdf.text(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${inv.total||0} SAR`, 40, 150);
      docPdf.text(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${inv.createdAt? new Date(inv.createdAt).toLocaleDateString('ar-SA'): ''}`, 40, 170);
      docPdf.save(`${inv.invoiceId||id}.pdf`);
    });

    // Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    function showNotif(text){ notif.classList.remove('hidden'); notifText.textContent = text; }
    hideNotif.addEventListener('click', ()=> notif.classList.add('hidden'));

    async function refreshAll(){ await Promise.all([fetchOrganizations(), fetchInvoices()]); renderKPIs(); }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    await refreshAll();
  </script>
</body>
</html>
