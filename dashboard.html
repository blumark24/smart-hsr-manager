<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart HSR | Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ</title>

  <!-- META -->
  <meta name="description" content="Ù†Ø¸Ø§Ù… Smart HSR Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ØªÙ†ÙÙŠØ°ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ">
  <meta name="keywords" content="Smart HSR, Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©, Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©, Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ…, Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ, ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
  <meta name="author" content="Smart HSR">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="Smart HSR | Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ">
  <meta property="og:description" content="Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ØªÙ†ÙÙŠØ°ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="ar_SA">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Smart HSR | Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ">
  <meta name="twitter:description" content="Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ØªÙ†ÙÙŠØ°ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©">

  <!-- ASSETS -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="alternate icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="favicon.svg">
  <link rel="stylesheet" href="output.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <!-- STYLES (Ù†ÙØ³ ØªØµÙ…ÙŠÙ…Ùƒ ØªÙ…Ø§Ù…Ø§Ù‹) -->
  <style>
    :root { --color-navy:#0A1931; --color-teal:#18A5A2; --color-light-teal:#ACE2E1; --color-gray-bg:#F7F9FC; --color-shadow-base:rgba(10,25,49,.4);}
    body { font-family:'Tajawal',sans-serif; background-color:var(--color-gray-bg); color:var(--color-navy);}
    .kpi-open-gradient{background:linear-gradient(135deg,#EF4444 0%,#B91C1C 100%);color:#fff;box-shadow:0 10px 20px rgba(185,28,28,.4)}
    .kpi-closed-gradient{background:linear-gradient(135deg,#10B981 0%,#18A5A2 100%);color:#fff;box-shadow:0 10px 20px rgba(24,165,162,.4)}
    .kpi-images-gradient{background:linear-gradient(135deg,#3B82F6 0%,#0A1931 100%);color:#fff;box-shadow:0 10px 20px rgba(59,130,246,.4)}
    .kpi-missing-gradient{background:linear-gradient(135deg,#FCD34D 0%,#F97316 100%); color:var(--color-navy); box-shadow:0 10px 20px rgba(253,211,77,.4)}
    .kpi-card-professional{transition:.3s; border-radius:1.5rem; position:relative; overflow:hidden; transform:perspective(1px) translateZ(0)}
    .kpi-card-professional::before{content:""; position:absolute; bottom:0; left:0; right:0; height:5px; background-color:rgba(255,255,255,.2); transition:height .3s}
    .kpi-card-professional:hover{transform:translateY(-8px) scale(1.02); z-index:10}
    .kpi-card-professional:hover::before{height:100%; opacity:.1}
    .ai-button-primary{background:var(--color-teal); color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(24,165,162,.5)}
    .ai-button-primary:hover:not(:disabled){background:#148f8c; transform:translateY(-2px); box-shadow:0 8px 20px rgba(24,165,162,.8)}
    .ai-button-secondary{background:var(--color-navy); color:#fff; transition:.3s; box-shadow:0 4px 10px rgba(10,25,49,.6)}
    .ai-button-secondary:hover:not(:disabled){background:#1a3053; transform:translateY(-2px); box-shadow:0 6px 15px rgba(10,25,49,.8)}
    .ai-button-vision{background:#9333ea; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(147,51,234,.5)}
    .ai-button-vision:hover:not(:disabled){background:#7e22ce; transform:translateY(-2px); box-shadow:0 8px 20px rgba(147,51,234,.8)}
    .ai-button-root-cause{background:#881337; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(136,19,55,.5)}
    .ai-button-root-cause:hover:not(:disabled){background:#9f1239; transform:translateY(-2px); box-shadow:0 8px 20px rgba(136,19,55,.8)}
    .ai-button-comm{background:#F97316; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(249,115,22,.5)}
    .ai-button-comm:hover:not(:disabled){background:#ea580c; transform:translateY(-2px); box-shadow:0 8px 20px rgba(249,115,22,.8)}
    .ai-button-grounding{background:#10B981; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(16,185,129,.5)}
    .ai-button-grounding:hover:not(:disabled){background:#059669; transform:translateY(-2px); box-shadow:0 8px 20px rgba(16,185,129,.8)}
    .loading-spinner{border:4px solid rgba(255,255,255,.3); border-top:4px solid var(--color-light-teal); border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; margin-left:8px}
    .ai-button-primary .loading-spinner,.ai-button-vision .loading-spinner,.ai-button-comm .loading-spinner,.ai-button-grounding .loading-spinner,.ai-button-secondary .loading-spinner,.ai-button-root-cause .loading-spinner{border-top:4px solid #0A1931}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .image-container{position:relative; overflow:hidden; border-radius:.75rem; box-shadow:0 4px 10px var(--color-shadow-base)}
    .image-label{position:absolute; bottom:0; right:0; background:var(--color-navy); color:#fff; padding:.5rem 1rem; font-size:.875rem; font-weight:700; border-top-left-radius:.75rem}
    .observation-item{transition:.2s; border-right:4px solid transparent; cursor:pointer}
    .observation-item:hover{background:#E6F3F3; border-right-color:var(--color-teal)}
    .observation-item.active{background:#E6F3F3; border-right-color:var(--color-navy); box-shadow:0 0 10px rgba(0,0,0,.1)}
    .comparison-wrapper{position:relative; max-width:100%; overflow:hidden; user-select:none; cursor:ew-resize; border-radius:.75rem}
    .comparison-wrapper img,.comparison-wrapper video{display:block; width:100%; height:auto}
    .comparison-wrapper .after-image{position:absolute; top:0; left:0; height:100%; width:50%; overflow:hidden}
    .comparison-wrapper .after-image img,.comparison-wrapper .after-image video{position:absolute; top:0; left:0; width:100%; height:auto}
    .comparison-wrapper .comparison-divider{position:absolute; top:0; left:50%; width:4px; height:100%; background:var(--color-teal); transform:translateX(-50%); cursor:grab; z-index:10; box-shadow:0 0 10px rgba(24,165,162,.8); border-radius:2px; transition:width .1s}
    .comparison-wrapper .comparison-divider:active{cursor:grabbing}
    .comparison-wrapper .comparison-divider-handle{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:40px; height:40px; background:#fff; border:3px solid var(--color-teal); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 15px rgba(0,0,0,.3)}
    .comparison-label{position:absolute; z-index:5; padding:.5rem 1rem; font-size:.875rem; font-weight:700; color:#fff; border-radius:.5rem; opacity:.9; box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .label-before{top:10px; right:10px; background:#B91C1C}
    .label-after{top:10px; left:10px; background:#10B981}
    .communication-draft{white-space:pre-wrap; text-align:right; direction:rtl; font-family:'Tajawal',sans-serif; border-right:4px solid var(--color-teal); padding-right:1rem; line-height:1.8; background:#f8fafc}
    .kpi-insight-container{border-radius:1.5rem; box-shadow:0 10px 30px rgba(0,0,0,.1); border-top:5px solid var(--color-navy)}
    .source-link{color:#0d9488; text-decoration:none; transition:color .2s}
    .source-link:hover{color:var(--color-navy); text-decoration:underline}
    audio{width:100%; margin-top:10px}
    .modal{display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,.6); align-items:center; justify-content:center}
    .modal-content{background:#fefefe; margin:5% auto; padding:30px; border-radius:1.5rem; width:90%; max-width:800px; box-shadow:0 10px 40px rgba(0,0,0,.3); animation:slide-up .3s ease-out; position:relative}
    .input-group-wrapper{display:flex; gap:1rem}
    .input-group{flex-grow:1; text-align:center}
    @media print{
      body{background:#fff!important; color:#000!important; width:210mm; min-height:297mm; margin:0}
      .no-print,#observationsList,#hero,#operational-dashboard,#ai-features,footer,.modal{display:none!important}
      #observationDetail{display:block!important; max-width:100%!important; margin:0!important; padding:0!important; box-shadow:none!important; border:none!important}
      .kpi-insight-container,.bg-white{box-shadow:none!important; border:none!important; padding:0!important; margin:0!important}
      .comparison-wrapper{cursor:default}
      .comparison-divider,.comparison-label{display:none!important}
      .comparison-wrapper .after-image{width:100%!important; overflow:visible!important}
      .comparison-wrapper .after-image img{position:static!important}
      .grid.grid-cols-1.md\3a grid-cols-3{display:block!important; border:1px solid #ccc; margin-bottom:10px}
      .grid.grid-cols-1.md\3a grid-cols-3>div{border:none!important; padding:5px}
      .print-logo{display:block!important}
    }

    /* Ù†Ø¨Ø¶ Ù†Ø§Ø¹Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù Ø­ÙˆÙ„ Ø²Ø± Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© */
.legend-toggle::after{
  content:"";
  position:absolute;
  inset:-6px;                /* Ù‡Ø§Ù„Ø© Ø®Ø§Ø±Ø¬ÙŠØ© ØµØºÙŠØ±Ø© */
  border-radius:50%;
  box-shadow:0 0 0 0 rgba(24,165,162,0.45);
  opacity:0;
  pointer-events:none;
  animation:legendSoftRing 5s ease-out infinite;
}

/* Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¨Ø¶ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© (Ø­Ø§Ù„Ø© active) */
.legend-toggle.active::after{
  animation:none;
}

/* Ø§Ø­ØªØ±Ø§Ù… ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© */
@media (prefers-reduced-motion: reduce){
  .legend-toggle::after{ animation:none; }
}

/* Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„Ù†Ø¨Ø¶ */
@keyframes legendSoftRing{
  0%, 80%{
    opacity:0;
    box-shadow:0 0 0 0 rgba(24,165,162,0);
  }
  85%{
    opacity:.6;
    box-shadow:0 0 0 0 rgba(24,165,162,0.45);
  }
  100%{
    opacity:0;
    box-shadow:0 0 0 22px rgba(24,165,162,0); /* ÙŠØªÙ„Ø§Ø´Ù‰ Ù„Ù„Ø®Ø§Ø±Ø¬ */
  }
}

  </style>

<link rel="stylesheet" href="modal-style.css">
<link rel="stylesheet" href="style-custom.css">

  
</head>

<body class="text-gray-800">

<!-- ========== SMART HSR EXECUTIVE HEADER ========== -->
<header id="hsrHeader" class="hsr-header">
  <div class="hsr-top">
    <!-- Ø´Ø¹Ø§Ø± -->
    <div class="brand">
      <span class="dot"></span>
      <strong>Smart HSR</strong>
      <span class="accent">System</span>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
 <div class="user-info">
  <i data-lucide="user" class="icon"></i>
  <div class="user-text">
    <span id="userFullInfo">
      <span id="userName">â€”</span>
      <span id="userRole" class="role-badge">â€”</span>
    </span>
  </div>
</div>


    <!-- Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ -->
    <button id="menuToggle" class="menu-toggle">
      <i data-lucide="menu"></i>
    </button>

    <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
    <div class="actions">
      <div id="gpsIndicator" class="gps-indicator" title="Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹">
        <span class="circle off"></span>
        <small id="gpsText">ØºÙŠØ± Ù…ØªØ§Ø­</small>
      </div>

      <button class="btn primary" onclick="window.open('mobile-map.html','_blank')">
        <i data-lucide='map'></i> <span> Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø°ÙƒÙŠØ©</span>
      </button>

      <button id="logoutBtn" class="btn dark">
        <i data-lucide='log-out'></i> <span>Ø®Ø±ÙˆØ¬</span>
      </button>
    </div>
  </div>
</header>

<style>
:root {
  --primary-teal:#0ea5a1;
  --secondary-navy:#0b2b3a;
  --white:#ffffff;
}

.hsr-header {
  background: linear-gradient(90deg, var(--secondary-navy) 0%, var(--primary-teal) 100%);
  color: var(--white);
  padding: 0.6rem 1rem;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  z-index: 1000;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  backdrop-filter: blur(6px);
}

body { padding-top: 68px; }

.hsr-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
}

/* Ø´Ø¹Ø§Ø± */
.brand {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 1.15rem;
  font-weight: 700;
}
.brand .dot {width:10px;height:10px;background:#22c55e;border-radius:50%;}
.brand .accent {color:#d1f4f2;}

/* ===== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===== */
.user-info {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  background: rgba(255,255,255,0.1);
  padding: 6px 12px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.user-info .icon {
  width: 20px;
  height: 20px;
  opacity: 0.9;
}
.user-text {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  white-space: nowrap;
}
#userName {
  font-size: 0.95rem;
  font-weight: 700;
  color: #fff;
}
#userRole {
  font-size: 0.8rem;
  border-radius: 6px;
  padding: 3px 8px;
  text-transform: capitalize;
}

/* ===== Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ===== */
.user-role-inspector {
  background: rgba(16,185,129,0.2);
  color: #10b981; /* Ù…Ø±Ø§Ù‚Ø¨ - Ø£Ø®Ø¶Ø± */
}
.user-role-contractor {
  background: rgba(249,115,22,0.2);
  color: #f97316; /* Ù…Ù‚Ø§ÙˆÙ„ - Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
}
.user-role-manager {
  background: rgba(59,130,246,0.2);
  color: #3b82f6; /* Ù…Ø¯ÙŠØ± - Ø£Ø²Ø±Ù‚ */
}

/* ===== Ø§Ù„Ø£Ø²Ø±Ø§Ø± ===== */
.actions {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.actions .btn {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  padding: 0.35rem 0.7rem;
  border: none;
  border-radius: 8px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
}
.btn.primary{background:var(--primary-teal);color:#fff;}
.btn.dark{background:rgba(255,255,255,0.1);color:#fff;}
.btn:hover{transform:scale(1.04);opacity:0.9;}

.gps-indicator{display:flex;align-items:center;gap:0.3rem;}
.gps-indicator .circle{width:10px;height:10px;border-radius:50%;}
.circle.off{background:#ef4444;}
.circle.on{background:#22c55e;}

.menu-toggle{display:none;background:transparent;border:none;color:#fff;cursor:pointer;}
@media (max-width:768px){
  .actions{display:none;flex-direction:column;width:100%;background:var(--secondary-navy);padding:0.7rem;border-radius:8px;margin-top:0.5rem;}
  .actions.active{display:flex;}
  .menu-toggle{display:block;}
  .user-info {width: 100%;justify-content: center;margin-top: 6px;}
}

/* Toast */
.toast{
  position:fixed;bottom:20px;right:20px;background:#0ea5a1;color:white;
  padding:10px 18px;border-radius:10px;font-size:15px;box-shadow:0 6px 18px rgba(0,0,0,0.2);
  opacity:0;transform:translateY(10px);transition:all 0.4s ease;z-index:2000;
}
.toast.show{opacity:1;transform:translateY(0);}
.spin{animation:spin 1s linear infinite;}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCXCiNeaO9lhM79tKb98x4oaNqNy5xKvWM",
  authDomain: "smart-hsr-manager.firebaseapp.com",
  projectId: "smart-hsr-manager",
  storageBucket: "smart-hsr-manager.firebasestorage.app",
  messagingSenderId: "38965508031",
  appId: "1:38965508031:web:6fd0b6c6b0b63fa513930a"
};



const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const logoutBtn = document.getElementById('logoutBtn');
const userName = document.getElementById('userName');
const userRole = document.getElementById('userRole');
const menuToggle = document.getElementById('menuToggle');
const actions = document.querySelector('.actions');

// ===== Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore =====
onAuthStateChanged(auth, async (user) => {
  if (user) {
    let stored = JSON.parse(localStorage.getItem("hsrUserData") || "{}");

    try {
      // Ø£ÙˆÙ„Ø§Ù‹ Ù†Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨Ù‡ Ù…Ù† managers
      const ref1 = doc(db, "managers", user.uid);
      const snap1 = await getDoc(ref1);
      if (snap1.exists()) stored = snap1.data();
      else {
        // Ù„Ùˆ Ù…Ø§ ÙˆØ¬Ø¯Ù†Ø§Ù‡ Ù†Ø­Ø§ÙˆÙ„ users
        const ref2 = doc(db, "users", user.uid);
        const snap2 = await getDoc(ref2);
        if (snap2.exists()) stored = snap2.data();
      }
      localStorage.setItem("hsrUserData", JSON.stringify(stored));
    } catch (err) {
      console.warn("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", err);
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¯ÙˆØ± Ø¥Ù„Ù‰ Ø¹Ø±Ø¨ÙŠ + ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù„ÙˆÙ†
    const rawRole = (stored.role || "manager").toLowerCase().trim();
    let arabicRole = "";
    let roleClass = "";

    if (rawRole.includes("manager") || rawRole.includes("Ù…Ø¯ÙŠØ±")) {
      arabicRole = "Ù…Ø¯ÙŠØ±";
      roleClass = "user-role-manager";
    } else if (rawRole.includes("inspector") || rawRole.includes("Ù…Ø±Ø§Ù‚Ø¨")) {
      arabicRole = "Ù…Ø±Ø§Ù‚Ø¨";
      roleClass = "user-role-inspector";
    } else if (rawRole.includes("contractor") || rawRole.includes("Ù…Ù‚Ø§ÙˆÙ„")) {
      arabicRole = "Ù…Ù‚Ø§ÙˆÙ„";
      roleClass = "user-role-contractor";
    } else {
      arabicRole = "Ù…Ø³ØªØ®Ø¯Ù…";
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ÙˆØ± ÙÙŠ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ø£Ù†ÙŠÙ‚
    userName.textContent = stored.name || user.displayName || "Ù…Ø³ØªØ®Ø¯Ù…";
    userRole.className = roleClass;
    userRole.textContent = arabicRole;

  } else {
    redirectToLogin();
  }
});

// ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ =====
logoutBtn.addEventListener('click', async () => {
  logoutBtn.innerHTML = "<i data-lucide='loader-2' class='spin'></i> Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...";
  logoutBtn.disabled = true;
  lucide.createIcons();

  try {
    await signOut(auth);
    localStorage.removeItem("hsrUserData");
    showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­ âœ”ï¸");
    setTimeout(() => redirectToLogin(), 1600);
  } catch (e) {
    showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ âŒ");
    logoutBtn.disabled = false;
    logoutBtn.innerHTML = "<i data-lucide='log-out'></i> Ø®Ø±ÙˆØ¬";
    lucide.createIcons();
  }
});

menuToggle.addEventListener('click', () => actions.classList.toggle('active'));

function redirectToLogin() {
  const candidates = ["login.html", "../login.html", "/login.html", "./login.html"];
  for (const path of candidates) {
    fetch(path, { method: "HEAD" })
      .then(res => { if (res.ok) window.location.href = path; })
      .catch(()=>{});
  }
  setTimeout(()=>window.location.href="login.html", 2000);
}

function showToast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.classList.add('show'), 50);
  setTimeout(() => {t.classList.remove('show'); setTimeout(() => t.remove(), 500);}, 2000);
}

document.addEventListener('DOMContentLoaded', () => lucide.createIcons());
</script>




    <!-- HERO -->
    <section id="hero" class="text-center py-12 md:py-16 bg-white rounded-3xl shadow-2xl mb-12 border-b-8 border-t-8 border-teal-100 no-print">
      <h1 class="text-5xl md:text-7xl font-extrabold text-gray-900 tracking-tight" style="color:var(--color-navy);">
        Smart HSR <span style="color:var(--color-teal);">Dashboard</span>
      </h1>
      <h2 class="text-xl md:text-3xl font-extrabold text-gray-600 mt-4">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ</h2>
      <p class="mt-4 text-lg max-w-4xl mx-auto text-gray-500 font-medium">
        "Ù…Ù†ØµØ© ØªÙ†ÙÙŠØ°ÙŠØ© Ø°ÙƒÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©ØŒ ØªÙˆÙØ± Ø±Ø¤ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡ ÙˆØªØ¯Ø¹Ù… Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."
      </p>
    </section>

    <!-- OBSERVATIONS -->
    <section id="observations-log" class="my-20">
      <div class="text-center mb-12 no-print">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color:var(--color-navy);">Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ:Ø¯Ù‚Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù†Øµ</h3>
        <p class="mt-3 text-lg text-gray-600">Ø¹Ø±Ø¶ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ù…Ø¹ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¢Ù„ÙŠ.</p>
        <button id="add-observation-btn" class="ai-button-primary rounded-full px-6 py-2 text-md font-bold mt-4 flex items-center justify-center mx-auto" onclick="openModal('smartInputModal')">
          <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ)
        </button>
      </div>

      <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl grid grid-cols-1 lg:grid-cols-3 gap-8 border border-gray-200">
        <!-- List + Filter -->
        <div class="lg:col-span-1 border-b lg:border-b-0 lg:border-l border-gray-300 lg:pr-6 pb-6 lg:pb-0 no-print">
          <h4 class="text-2xl font-bold mb-4" style="color:var(--color-teal);">ØªØµÙÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h4>
          <select id="observationFilter" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm transition-all duration-300" onchange="handleFilterChange()">
            <option value="Ø§Ù„ÙƒÙ„">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
            <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
            <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
            <option value="ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©">ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
            <option value="Ø¬ÙˆØ¯Ø©">Ø¬ÙˆØ¯Ø©</option>
            <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
            <option value="Ø³Ù„Ø§Ù…Ø©">Ø³Ù„Ø§Ù…Ø©</option>
            <option value="Ø¨ÙŠØ¦Ø©">Ø¨ÙŠØ¦Ø©</option>
          </select>

          <h4 class="text-2xl font-bold mt-8 mb-3" style="color:var(--color-navy);">Ø§Ù„Ù…Ù€Ù„Ø§Ø­Ø¸Ù€Ù€Ø§Øª</h4>
          <div id="observationsList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
            <div class="text-center text-gray-500 mt-10">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ...</div>
          </div>
        </div>

        <!-- Details -->
        <div class="lg:col-span-2 bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-inner">
          <div class="print-logo hidden mb-6 p-4 border-b border-gray-300">
            <h2 class="text-3xl font-extrabold text-gray-900" style="color:var(--color-navy);">ØªÙ‚Ø±ÙŠØ± Smart HSR Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ</h2>
            <p id="printTitle" class="text-xl font-bold text-teal-600 mt-2"></p>
          </div>

          <h4 class="text-2xl font-extrabold mb-4 border-b-2 border-gray-300 pb-2" style="color:var(--color-teal);">
            Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ (AI Insights)
          </h4>

          <div id="observationDetail" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm font-medium mb-6 p-4 bg-white rounded-xl shadow-sm border">
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span><span id="detailTitle" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">Ø§Ù„ØªØµÙ†ÙŠÙ:</span><span id="detailType" class="block font-bold text-teal-600"></span></div>
              <div class="p-2"><span class="block text-gray-500">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span><span id="detailLocation" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù„Ø§Øº:</span><span id="detailDate" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:</span><span id="detailStatus" class="inline-block px-3 py-1 text-sm font-semibold rounded-full text-white"></span></div>
              <div class="p-2"><span class="block text-gray-500">Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù„Ø§Øº:</span><span id="detailID" class="block font-bold text-gray-800"></span></div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-md mb-6 border-l-4 border-teal-500">
              <h5 class="text-xl font-bold mb-3" style="color:var(--color-navy);">ÙˆØµÙ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</h5>
              <p id="detailDescription" class="text-gray-700 leading-relaxed"></p>
              <div id="actionPlanContainer" class="mt-4 p-3 bg-teal-50 rounded-lg hidden">
                <h6 class="font-bold text-teal-700">Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© (Gemini AI)</h6>
                <p id="actionPlan" class="text-sm text-teal-900 mt-1"></p>
              </div>
            </div>

            <div id="resolutionNoteContainer" class="bg-green-50 p-5 rounded-2xl shadow-md mb-6 border-l-4 border-green-500 hidden">
              <h5 class="text-xl font-bold mb-3 text-green-700">ğŸ“ Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ© Ù„Ù„Ø¥ØºÙ„Ø§Ù‚</h5>
              <p id="resolutionNote" class="text-gray-700 leading-relaxed"></p>
            </div>

            <div id="imageComparisonWrapper" class="comparison-wrapper mb-6 hidden">
              <img id="beforeImage" class="before-image w-full h-auto" alt="ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
              <div id="afterImageContainer" class="after-image"><img id="afterImage" class="w-full h-auto" alt="ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="></div>
              <div id="comparisonDivider" class="comparison-divider no-print"><div class="comparison-divider-handle"><i data-lucide="arrow-left-right" class="w-4 h-4 text-teal-600"></i></div></div>
              <span class="comparison-label label-before no-print">Ù‚Ø¨Ù„</span><span class="comparison-label label-after no-print">Ø¨Ø¹Ø¯</span>
            </div>

            <div id="mediaContainer" class="image-container mb-6 hidden"><div id="mediaContent" class="w-full h-auto rounded-xl"></div><span class="image-label">Ù…Ø±ÙÙ‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</span></div>

            <div id="noImageMessage" class="bg-yellow-100 p-4 rounded-xl text-center text-yellow-800 font-medium mb-6 hidden">
              <i data-lucide="alert-triangle" class="w-5 h-5 inline-block ml-2"></i> Ù„Ø§ ØªØªÙˆÙØ± ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.
            </div>

            <div id="aiAnalysisSection" class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-gray-200">
              <h5 class="text-xl font-bold mb-4" style="color:var(--color-navy);">Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ (Gemini AI)</h5>
              <div class="flex flex-wrap gap-3 no-print">
                <button id="vision-btn" class="ai-button-vision rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="analyzeImage('vision')">
                  <i data-lucide="eye" class="w-4 h-4 ml-2"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¨Ø§Ù„Ø±Ø¤ÙŠØ© (Vision)
                </button>
                <button id="root-cause-btn" class="ai-button-root-cause rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="analyzeImage('root-cause')">
                  <i data-lucide="microscope" class="w-4 h-4 ml-2"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ
                </button>
                <button id="comm-btn" class="ai-button-comm rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="generateCommunicationDraft()">
                  <i data-lucide="send" class="w-4 h-4 ml-2"></i> ØµÙŠØ§ØºØ© Ø£Ù…Ø± Ø§Ù„Ø¹Ù…Ù„
                </button>
                <button id="pdf-report-btn" class="ai-button-grounding rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="generatePdfReport()">
                  <i data-lucide="file-text" class="w-4 h-4 ml-2"></i> ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± PDF
                </button>
              </div>

              <div id="aiResultContainer" class="mt-5 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                <h6 id="aiResultTitle" class="font-bold text-lg mb-2" style="color:var(--color-teal);"></h6>
                <div id="aiResultContent" class="text-gray-700"></div>
              </div>
            </div>

            <div id="actionButtons" class="mt-6 pt-4 border-t border-gray-300 flex justify-end gap-3 no-print">
              <button id="updateStatusBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150" onclick="alert('ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° (ØªØ¬Ø±ÙŠØ¨ÙŠ)')">
                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"
              </button>
              <button id="completeObservationBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150" onclick="openModal('closeoutModal')">
                <i data-lucide="lock" class="w-4 h-4 ml-2"></i> Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ (ØµÙˆØ±Ø© Ø¨Ø¹Ø¯)
              </button>
              <button id="alreadyCompletedBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150 hidden" disabled>
                <i data-lucide="check" class="w-4 h-4 ml-2"></i> Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù…ØºÙ„Ù‚Ø© ÙˆÙ…ÙˆØ«Ù‚Ø©
              </button>
            </div>
          </div>

          <div id="detailPlaceholder" class="text-center space-y-4">
            <p class="text-gray-500 mt-16 text-lg">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù…Ø°ÙƒØ±Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©.</p>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M17 10h.01"/>
            </svg>
          </div>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section id="operational-dashboard" class="my-20 no-print">
      <div class="text-center mb-12">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color:var(--color-navy);">ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­ÙŠÙˆÙŠØ© (Vital Metrics)</h3>
        <p class="mt-3 text-lg text-gray-600">ØªØªØ¨Ø¹ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø¨Ø§Ù„ØµÙˆØ± Ù„Ø¶Ù…Ø§Ù† ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚.</p>
      </div>

      <div id="kpiContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
        <div class="p-6 bg-white rounded-2xl shadow-xl border-t-4 border-gray-200">
          <p class="text-xl font-medium text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
          <p class="text-5xl font-extrabold text-gray-700 mt-2">--</p>
        </div>
      </div>

      <div class="mt-12 text-center">
        <button id="kpi-insight-button" class="ai-button-secondary rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto" onclick="generateKpiInsights()">
          <i data-lucide="bar-chart-3" class="w-5 h-5 ml-2"></i> âœ¨ ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± ØªÙ†ÙÙŠØ°ÙŠ Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù„ÙˆØ­Ø© (Gemini AI)
        </button>
        <div id="kpi-insight-result" class="mt-6 text-sm"></div>
      </div>
    </section>

    <!-- AI features (static) -->
    <section id="ai-features" class="my-20 bg-white p-8 md:p-12 rounded-3xl shadow-2xl border-t-8 border-[--color-teal] no-print">
      <div class="text-center mb-12">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color:var(--color-navy);">ğŸ§  Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙÙŠ ØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
        <p class="mt-3 text-lg text-gray-600">Ø§Ø³ØªÙØ¯ Ù…Ù† Ù†Ù…Ø§Ø°Ø¬ Gemini Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù‚Ø±Ø§Ø±Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ°.</p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-7 gap-8 text-center">
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:#9333ea;">ğŸ‘ï¸</span><h4 class="font-extrabold text-lg mb-1" style="color:var(--color-navy);">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¤ÙŠØ©</h4>
          <p class="text-xs text-gray-600">ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:var(--color-teal);">âš™ï¸</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">Ø®Ø·Ø© Ø¹Ù…Ù„ Ø¢Ù„ÙŠØ©</h4>
          <p class="text-xs text-gray-600">ØªÙˆÙ„ÙŠØ¯ Ø®Ø·ÙˆØ§Øª ØªÙ†ÙÙŠØ°ÙŠØ© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:var(--color-teal);">ğŸš¨</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h4>
          <p class="text-xs text-gray-600">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© ÙˆØ§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ ÙÙŠ Ù‡ÙŠÙƒÙ„ JSON.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:#881337;">ğŸ”¬</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ</h4>
          <p class="text-xs text-gray-600">Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¨Ø¨ Ø¬Ø°Ø±ÙŠ ÙˆÙ†ØµÙŠØ­Ø© ÙˆÙ‚Ø§Ø¦ÙŠØ©.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:#F97316;">âœ‰ï¸</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ØµÙŠØ§ØºØ© Ø§Ù„Ø§ØªØµØ§Ù„</h4>
          <p class="text-xs text-gray-600">ØªÙˆÙ„ÙŠØ¯ Ù…Ø³ÙˆØ¯Ø© Ø£Ù…Ø± Ø¹Ù…Ù„ Ø£Ùˆ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:var(--color-navy);">ğŸ”Š</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙˆØªÙŠ</h4>
          <p class="text-xs text-gray-600">ØªÙ„Ø®ÙŠØµ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ Ù…Ù„Ù ØµÙˆØªÙŠ.</p>
        </div>
        <div class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
          <span class="text-4xl block mb-2" style="color:#10B981;">ğŸŒ</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</h4>
          <p class="text-xs text-gray-600">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ… Ù„Ø§Ø³ØªØ­Ø¶Ø§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©.</p>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="text-center mt-20 py-12 border-t-4 border-teal-200 bg-white rounded-t-3xl shadow-2xl no-print">
      <div class="max-w-6xl mx-auto px-4">
        <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="color:var(--color-navy);">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù…Ø¹ Smart HSR</h3>
        <p class="mt-3 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ ÙŠÙØ­ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù† Ø¥Ù„Ù‰ Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ØªÙ†ÙÙŠØ°ÙŠÙ‘Ø©</p>
        <a href="http://wa.me/966507006849" target="_blank" class="mt-8 inline-block bg-[--color-teal] text-white font-bold py-4 px-12 rounded-full text-xl hover:bg-[--color-navy] transition-all duration-300 transform hover:scale-105 shadow-lg">Ø§Ø·Ù„Ø¨ Ø¹Ø±Ø¶Ù‹Ø§ ØªØ¬Ø±ÙŠØ¨ÙŠÙ‹Ø§ Ø§Ù„Ø¢Ù†</a>
        <div class="mt-12 pt-8 border-t border-gray-200">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-gray-600 mb-6">
            <div><h4 class="font-bold text-gray-800 mb-2">Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h4><p>Ù†Ø¸Ø§Ù… Smart HSR Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ</p></div>
            <div><h4 class="font-bold text-gray-800 mb-2">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h4><p>Blumark24@gmail.com</p></div>
            <div><h4 class="font-bold text-gray-800 mb-2">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª</h4><p>0507006849</p></div>
          </div>
          <div class="text-xs text-gray-500">
            <p class="mb-2">&copy; 2025 Smart HSR. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
            <p id="userInfo">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©...</p>
          </div>
        </div>
      </div>
    </footer>
  </main>

  <!-- MODALS -->
  <div id="smartInputModal" class="modal no-print">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('smartInputModal')">&times;</span>
      <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b" style="color:var(--color-navy);">ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Smart HSR)</h2>

      <div id="modalStep1">
        <p class="text-lg text-gray-600 mb-4">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø£Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù†ØµØŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø§Ù„ØµÙˆØ±Ø©)</p>
        <textarea id="rawObservationInput" rows="5" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm" placeholder="Ù…Ø«Ø§Ù„: ÙŠÙˆØ¬Ø¯ ØªØ¬Ù…Ø¹ Ù„Ù„Ù…ÙŠØ§Ù‡ Ø¹Ù„Ù‰ Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø®Ø¯Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙƒÙŠÙ„Ùˆ 52..." oninput="checkSmartInputState()"></textarea>

        <div class="mt-4 input-group-wrapper">
          <div class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (GPS):</label>
            <p id="locationStatus" class="text-sm font-semibold text-gray-500">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯</p>
            <input type="hidden" id="inputLatitude"><input type="hidden" id="inputLongitude">
            <button id="getLocationBtn" class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto" onclick="getLocation()" type="button">
              <i data-lucide="map-pin" class="w-4 h-4 ml-2"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
            </button>
          </div>

          <div class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
            <label class="block text-sm font-medium text-gray-700 mb-2">Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:</label>
            <p id="fileStatus" class="text-sm font-semibold text-gray-500">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯</p>
            <!-- Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø±ÙØ¹ Ù„Ù„ØµÙˆØ± ÙÙ‚Ø· Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø¦Ù… Ø¹Ø¨Ø± ImgBB -->
            <input type="file" id="fileUploadInput" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
            <button class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto" onclick="document.getElementById('fileUploadInput').click()" type="button">
              <i data-lucide="upload" class="w-4 h-4 ml-2"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù
            </button>
          </div>
        </div>

        <div class="mt-6 text-center">
          <button id="processSmartInputBtn" class="ai-button-vision rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto" onclick="processSmartInput()" disabled>
            <i data-lucide="cpu" class="w-5 h-5 ml-2"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
          </button>
        </div>
      </div>

      <div id="modalResult" class="mt-8 pt-6 border-t border-gray-200 hidden">
        <h3 class="text-2xl font-bold mb-4" style="color:var(--color-teal);">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <div id="modalResultContent"></div>
        <div class="mt-6 text-center">
          <button class="ai-button-primary rounded-full px-6 py-2 text-md font-bold" onclick="closeModal('smartInputModal')">Ø¥ØºÙ„Ø§Ù‚ ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>
        </div>
      </div>
    </div>
  </div>

  <div id="closeoutModal" class="modal no-print">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('closeoutModal'); clearAfterUpload();">&times;</span>
      <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b text-green-700">ğŸ”’ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø© #<span id="closeoutId"></span></h2>
      <p class="text-lg text-gray-600 mb-4">Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŒ ÙŠØ¬Ø¨ ØªÙˆØ«ÙŠÙ‚ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø¨Ù€ <b>ØµÙˆØ±Ø© "Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­"</b> ÙˆÙ…Ø°ÙƒØ±Ø© Ø®ØªØ§Ù…ÙŠØ©.</p>

      <div class="p-6 bg-gray-50 rounded-xl border border-gray-200">
        <h3 class="text-xl font-bold mb-3" style="color:var(--color-navy);">1. ØªÙˆØ«ÙŠÙ‚ ØµÙˆØ±Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (After Photo)</h3>
        <div class="input-group p-4 border-2 border-dashed border-red-300 rounded-xl bg-white hover:border-red-500 transition-colors">
          <label class="block text-sm font-medium text-gray-700 mb-2">Ø±ÙØ¹ ØµÙˆØ±Ø© <b>Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­/Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</b> (<span class="text-red-500 font-bold">Ø¥Ù„Ø²Ø§Ù…ÙŠ</span>):</label>
          <p id="afterFileStatus" class="text-sm font-semibold text-gray-500">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯</p>
          <input type="file" id="afterFileUploadInput" accept="image/*" class="hidden" onchange="handleAfterFileUpload(event)">
          <button class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto" onclick="document.getElementById('afterFileUploadInput').click()" type="button">
            <i data-lucide="camera" class="w-4 h-4 ml-2"></i> Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
          </button>
        </div>

        <h3 class="text-xl font-bold mt-6 mb-3" style="color:var(--color-navy);">2. Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ©</h3>
        <textarea id="resolutionNoteInput" rows="4" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500 text-gray-700 shadow-sm" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ©..."></textarea>
      </div>

      <div class="mt-6 text-center">
        <button id="finalCloseoutBtn" class="bg-green-600 hover:bg-green-700 rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto transition-colors" onclick="completeObservation()" disabled>
          <i data-lucide="check-square" class="w-5 h-5 ml-2"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
        </button>
      </div>
    </div>
  </div>

  <!-- APP LOGIC (Firebase + Firestore + ImgBB) -->
  <script type="module">


    // =============================
    // 2) Ø­Ø§Ù„Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ø¨ÙŠØ§Ù†Ø§Øª
    // =============================
    let observationsData = [];          // Ø³Ù†Ù…Ù„Ø¤Ù‡ Ù…Ù† Firestore
    let currentSelectedObservation = null;
    const statusMap = {
      "PENDING": { color:'bg-red-600', text:'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' },
      "IN_PROGRESS": { color:'bg-yellow-600', text:'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' },
      "COMPLETED": { color:'bg-green-600', text:'ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' }
    };

    // Ø¹Ù†Ø§ØµØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹
    let currentFile = null, currentFileUrl = null;           // BEFORE (Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©)
    let currentAfterFile = null, currentAfterFileUrl = null; // AFTER (Ø¥ØºÙ„Ø§Ù‚)

    // =============================
    // 3) Ø®Ø¯Ù…Ø§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (ImgBB + Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø©)
    // =============================

    // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ Firebase Storage ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„
async function uploadImageToStorage(file, folder = "HSR") {
  const storage = getStorage(app);
  const fileName = Date.now() + "-" + file.name;
  const storageRef = ref(storage, `${folder}/${fileName}`);

  await uploadBytes(storageRef, file);
  const downloadUrl = await getDownloadURL(storageRef);

  return downloadUrl;  // Ù†Ø¹ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ÙÙ‚Ø·
}



    function kpis() {
      const totalReports = observationsData.length;
      const openReports  = observationsData.filter(o => o.status !== 'COMPLETED').length;
      const closedReports = totalReports - openReports;
      const reportsWithImages = observationsData.filter(o => !!o.imagePath).length;
      return { totalReports, openReports, closedReports, reportsWithImages };
    }

    function renderKPIs() {
      const { totalReports, openReports, closedReports, reportsWithImages } = kpis();
      const kpiContainer = document.getElementById('kpiContainer');
      kpiContainer.innerHTML = '';
      const kpiData = [
        {title:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª', value:totalReports, icon:'clipboard-list', gradientClass:'kpi-closed-gradient'},
        {title:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙØªÙˆØ­Ø©/Ø§Ù†ØªØ¸Ø§Ø±', value:openReports, icon:'alert-triangle', gradientClass:'kpi-open-gradient'},
        {title:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ØºÙ„Ù‚Ø©/Ù…Ø¹Ø§Ù„Ø¬Ø©', value:closedReports, icon:'check-circle', gradientClass:'kpi-closed-gradient'},
        {title:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙˆØ«Ù‚Ø© Ø¨Ø§Ù„ØµÙˆØ±', value:reportsWithImages, icon:'image', gradientClass:'kpi-images-gradient'}
      ];
      kpiData.forEach(kpi=>{
        kpiContainer.innerHTML += `
          <div class="kpi-card-professional p-6 ${kpi.gradientClass} flex items-center justify-between shadow-2xl">
            <div><p class="text-sm md:text-md font-medium">${kpi.title}</p>
            <p class="text-4xl md:text-5xl font-extrabold mt-1">${kpi.value}</p></div>
            <i data-lucide="${kpi.icon}" class="w-10 h-10 opacity-70"></i>
          </div>`;
      });
      lucide.createIcons();
    }

    function renderObservationsList(observations) {
      const list = document.getElementById('observationsList');
      list.innerHTML = '';
      if (!observations || observations.length === 0) {
        list.innerHTML = '<div class="text-center text-gray-500 mt-10 p-4 bg-gray-100 rounded-xl">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª.</div>';
        document.getElementById('detailPlaceholder').classList.remove('hidden');
        document.getElementById('observationDetail').classList.add('hidden');
        return;
      }
      observations.forEach(obs=>{
        const st = statusMap[obs.status] || {color:'bg-gray-500', text:obs.status};
        const isSel = currentSelectedObservation && obs.docId === currentSelectedObservation.docId ? 'active':'';
        list.innerHTML += `
          <div class="observation-item p-3 rounded-lg flex justify-between items-center ${isSel}" onclick="showObservationDetail('${obs.docId}')">
            <div>
              <p class="text-md font-bold text-gray-800 truncate max-w-[200px]">${escapeHTML(obs.title || '')}</p>
              <p class="text-xs text-gray-500 mt-1">${obs.date || ''} | ${escapeHTML(obs.type || '')}</p>
            </div>
            <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${st.color} text-white">${st.text}</span>
          </div>`;
      });
    }

    // =============================
    // 4) Ø±Ø¨Ø· Firestore
    // =============================
    async function loadFromFirestore() {
      if (!FIREBASE_READY) { seedLocalDemo(); return; }
      const q = query(collection(db, COLLECTION), orderBy('createdAt','desc'));
      const snapshot = await getDocs(q);
      const arr = [];
      snapshot.forEach(d=>{
        const data = d.data();
        arr.push({
          docId:d.id,
          id: data.displayId || 0,
          type:data.type || 'MAINTENANCE',
          date:data.date || '',
          title:data.title || '',
          status:data.status || 'PENDING',
          details:data.details || '',
          hasImage: !!data.imagePath,
          isComparative: !!data.isComparative,
          location:data.location || '',
          isVideo:false,
          imagePath:data.imagePath || null,
          fileMimeType:'image/jpeg',
          actionPlan:data.actionPlan || '',
          riskAssessment:data.riskAssessment || { priority:'Medium', timeframe:'72 hours' },
          resolutionNote:data.resolutionNote || null,
          afterImagePath:data.afterImagePath || null,
          createdAt:data.createdAt?.toMillis ? data.createdAt.toMillis(): (data.createdAt || Date.now()),
          isNewInput:false
        });
      });
      observationsData = arr;
    }

    async function addObservationToFirestore(payload) {
      if (!FIREBASE_READY) return null;
      const docRef = await addDoc(collection(db, COLLECTION), {
        ...payload,
        createdAt: serverTimestamp()
      });
      return docRef.id;
    }

    async function updateObservationInFirestore(docId, fields) {
      if (!FIREBASE_READY) return;
      await updateDoc(doc(db, COLLECTION, docId), { ...fields });
    }

    // =============================
    // 5) Ù…Ù†Ø·Ù‚ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (ÙƒÙ…Ø§ ÙÙŠ Ù†Ø³Ø®ØªÙƒ Ù…Ø¹ Ø±Ø¨Ø· Ø§Ù„Ø­ÙØ¸)
    // =============================
    window.showObservationDetail = function(docId) {
      const obs = observationsData.find(o=>o.docId===docId);
      if (!obs) return;
      currentSelectedObservation = obs;

      document.querySelectorAll('.observation-item').forEach(i=>i.classList.remove('active'));
      const li = Array.from(document.querySelectorAll('.observation-item')).find(el=>el.getAttribute('onclick')===`showObservationDetail('${docId}')`);
      if (li) li.classList.add('active');

      const st = statusMap[obs.status] || {color:'bg-gray-500', text:obs.status};
      setText('detailTitle', obs.title); setText('printTitle', `Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: ${obs.title}`);
      setText('detailType', obs.type); setText('detailDate', obs.date);
      setText('detailID', obs.id || '-'); setText('detailLocation', obs.location || '-');
      const ds = document.getElementById('detailStatus');
      ds.textContent = st.text; ds.className = `inline-block px-3 py-1 text-sm font-semibold rounded-full text-white ${st.color}`;
      document.getElementById('detailDescription').innerHTML = (obs.details || '').replace(/\n/g,'<br>');
      setText('actionPlan', `Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${obs.riskAssessment?.priority||'-'} | Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ: ${obs.riskAssessment?.timeframe||'-'}. Ø§Ù„Ø®Ø·Ø©: ${obs.actionPlan||'-'}`);
      document.getElementById('actionPlanContainer').classList.remove('hidden');

      // ÙˆØ³Ø§Ø¦Ø·
      hide('mediaContainer'); hide('imageComparisonWrapper'); hide('noImageMessage'); hide('resolutionNoteContainer');
      const mediaContent = document.getElementById('mediaContent'); mediaContent.innerHTML = '';
      if (obs.status==='COMPLETED' && obs.afterImagePath) {
        unhide('imageComparisonWrapper');
        document.getElementById('beforeImage').src = obs.imagePath || '';
        document.getElementById('afterImage').src  = obs.afterImagePath || '';
        setupImageComparison();
        setText('resolutionNote', obs.resolutionNote || 'Ù„Ù… ÙŠØªÙ… ØªÙˆÙÙŠØ± Ù…Ø°ÙƒØ±Ø© Ø¥ØºÙ„Ø§Ù‚ ØªÙØµÙŠÙ„ÙŠØ©.');
        unhide('resolutionNoteContainer');
      } else if (obs.imagePath) {
        unhide('mediaContainer');
        mediaContent.innerHTML = `<img class="w-full h-auto rounded-xl shadow-lg" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©" src="${obs.imagePath}">`;
      } else {
        unhide('noImageMessage');
      }

      const isCompleted = obs.status==='COMPLETED';
      toggleHidden('updateStatusBtn', isCompleted);
      toggleHidden('completeObservationBtn', isCompleted);
      toggleHidden('alreadyCompletedBtn', !isCompleted);

      hide('detailPlaceholder'); unhide('observationDetail'); hide('aiResultContainer');
      lucide.createIcons();
    };

    window.handleFilterChange = function() {
      const v = document.getElementById('observationFilter').value;
      let filtered = observationsData;
      if (v !== 'Ø§Ù„ÙƒÙ„') {
        const map = {"Ø¬Ø¯ÙŠØ¯":"PENDING","Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":"IN_PROGRESS","ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©":"COMPLETED","Ø¬ÙˆØ¯Ø©":"QUALITY","ØµÙŠØ§Ù†Ø©":"MAINTENANCE","Ø³Ù„Ø§Ù…Ø©":"SAFETY","Ø¨ÙŠØ¦Ø©":"ENVIRONMENT"};
        const key = map[v] || v;
        filtered = observationsData.filter(o => o.type===key || o.status===key);
      }
      renderObservationsList(filtered);
      if (filtered.length>0) showObservationDetail(filtered[0].docId);
      else { unhide('detailPlaceholder'); hide('observationDetail'); }
    };

    window.getLocation = function(){
      setHTML('locationStatus','<span class="text-yellow-600">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</span>');
      document.getElementById('getLocationBtn').disabled = true;
      navigator.geolocation?.getCurrentPosition(pos=>{
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        document.getElementById('inputLatitude').value = lat;
        document.getElementById('inputLongitude').value = lon;
        setHTML('locationStatus', `<span class="text-green-600">ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯:</span> ${lat.toFixed(4)}, ${lon.toFixed(4)}`);
        document.getElementById('getLocationBtn').disabled = false;
        checkSmartInputState();
      }, _err=>{
        setHTML('locationStatus','<span class="text-red-600">ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>');
        document.getElementById('getLocationBtn').disabled = false;
      });
    };

    window.checkSmartInputState = function(){
      const text = document.getElementById('rawObservationInput').value.trim();
      const lat = document.getElementById('inputLatitude').value;
      document.getElementById('processSmartInputBtn').disabled = !(text.length>0 || currentFile || lat);
    };

    window.handleFileUpload = function(e){
      const file = e.target.files[0];
      if (!file) {
        currentFile = null; currentFileUrl = null;
        setText('fileStatus','Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯'); checkSmartInputState(); return;
      }
      if (!file.type.startsWith('image/')) {
        alert('Ø­Ø§Ù„ÙŠØ§Ù‹ ÙŠØªÙ… Ø¯Ø¹Ù… Ø§Ù„ØµÙˆØ± ÙÙ‚Ø· Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ.'); e.target.value = ''; return;
      }
      currentFile = file;
      setText('fileStatus', `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`);
      checkSmartInputState();
    };

    window.processSmartInput = async function(){
      const rawText = document.getElementById('rawObservationInput').value.trim();
      const lat = document.getElementById('inputLatitude').value || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      const lon = document.getElementById('inputLongitude').value || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

      if (!rawText && !currentFile) { alert('Ø£Ø¯Ø®Ù„ ÙˆØµÙØ§Ù‹ Ø£Ùˆ ØµÙˆØ±Ø©.'); return; }

      hide('modalStep1'); unhide('modalResult');
      setHTML('modalResultContent', loaderHTML('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...'));

      try {
        let uploadedUrl = null;
        if (currentFile) {
uploadedUrl = await uploadImageToStorage(currentFile, "HSR/before");

        }

        // Ù†Ø­Ø³Ø¨ displayId Ø¨Ø³ÙŠØ·: Ø£ÙƒØ¨Ø± Ù‚ÙŠÙ…Ø© + 1
        const nextDisplayId = (observationsData.reduce((m,o)=>Math.max(m,o.id||0),0) + 1) || 1;
        const newDate = new Date().toISOString().slice(0,10);

        const payload = {
          displayId: nextDisplayId,
          type: "MAINTENANCE",
          date: newDate,
          title: rawText.substring(0,50) + (rawText.length>50?'...':''),
          status: "PENDING",
          details: `**ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¢Ù„ÙŠØ§Ù‹.**\nØ§Ù„ÙˆØµÙ Ø§Ù„Ø£ÙˆÙ„ÙŠ: "${rawText || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}"\nØ§Ù„Ù…ÙˆÙ‚Ø¹: (${lat}, ${lon})`,
          imagePath: uploadedUrl,
          isComparative: false,
          actionPlan: "Ø¥ØµÙ„Ø§Ø­ ÙÙˆØ±ÙŠ Ù„Ø£Ø¶Ø±Ø§Ø± Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¹Ø¨Ø± Ø±Ù‚Ø¹Ø© Ø§Ù„Ø¥Ø³ÙÙ„Øª (Patching).",
          riskAssessment: { priority:"High", timeframe:"48 hours" },
          location: `${lat}, ${lon}`,
          resolutionNote: null,
          afterImagePath: null
        };

        let docId = 'local-' + cryptoRandom();
        if (FIREBASE_READY) {
          docId = await addObservationToFirestore(payload);
        }
        // Ø­Ø¯Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
        observationsData.unshift({
          docId,
          id: nextDisplayId, ...payload,
          hasImage: !!payload.imagePath,
          isVideo: false,
          fileMimeType: 'image/jpeg',
          createdAt: Date.now(),
          isNewInput: true
        });

        renderObservationsList(observationsData);
        showObservationDetail(docId);

        setHTML('modalResultContent', successHTML('ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­.'));
        lucide.createIcons();

        // ØªÙ†Ø¸ÙŠÙ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        currentFile = null; currentFileUrl = null;
        document.getElementById('fileUploadInput').value = '';
        document.getElementById('rawObservationInput').value = '';
        setText('fileStatus','Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯');
        setText('locationStatus','Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯');
        document.getElementById('inputLatitude').value='';
        document.getElementById('inputLongitude').value='';
        document.getElementById('processSmartInputBtn').disabled = true;

      } catch (err) {
        console.error(err);
        setHTML('modalResultContent', errorHTML('ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.'));
      } finally {
        renderKPIs();
      }
    };

    window.openModal = function(id){
      document.getElementById(id).style.display = "flex";
      if (id==='closeoutModal' && currentSelectedObservation){
        setText('closeoutId', currentSelectedObservation.id || '-');
        clearAfterUpload();
      }
      if (id==='smartInputModal'){
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('rawObservationInput').value = '';
        setText('locationStatus','Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯');
        setText('fileStatus','Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯');
        document.getElementById('inputLatitude').value='';
        document.getElementById('inputLongitude').value='';
        currentFile = null; currentFileUrl = null;
        document.getElementById('fileUploadInput').value='';
        document.getElementById('processSmartInputBtn').disabled = true;
        hide('modalResult'); unhide('modalStep1');
      }
    };

    window.closeModal = function(id){ document.getElementById(id).style.display = "none"; };

    window.clearAfterUpload = function(){
      currentAfterFile = null; currentAfterFileUrl = null;
      document.getElementById('afterFileUploadInput').value='';
      setHTML('afterFileStatus','Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯ <span class="text-red-500 font-bold">(Ø¥Ù„Ø²Ø§Ù…ÙŠ)</span>');
      document.getElementById('resolutionNoteInput').value='';
      document.getElementById('finalCloseoutBtn').disabled = true;
    };

    window.handleAfterFileUpload = function(e){
      const file = e.target.files[0];
      if (!file) { currentAfterFile=null; currentAfterFileUrl=null; setHTML('afterFileStatus','Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯ <span class="text-red-500 font-bold">(Ø¥Ù„Ø²Ø§Ù…ÙŠ)</span>'); document.getElementById('finalCloseoutBtn').disabled=true; return; }
      if (!file.type.startsWith('image/')) { alert('ÙŠØ¬Ø¨ Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.'); e.target.value=''; return; }
      currentAfterFile = file;
      setHTML('afterFileStatus', `<span class="text-green-600">ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù:</span> ${file.name}`);
      // Ø³Ù†Ø±ÙØ¹Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"
      document.getElementById('finalCloseoutBtn').disabled = false;
    };

    window.completeObservation = async function(){
      if (!currentSelectedObservation) return;
      if (!currentAfterFile) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ ØµÙˆØ±Ø© "Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­".'); return; }

      const note = (document.getElementById('resolutionNoteInput').value || '').trim()
        || `ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ ÙÙŠ ${new Date().toLocaleString('ar-SA')} ÙˆØªÙˆØ«ÙŠÙ‚Ù‡ Ø¨Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø©.`;

      try {
        // Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© AFTER Ù„Ù€ ImgBB
        setButtonBusy('finalCloseoutBtn', true);
        const afterUrl = await uploadImageToStorage(currentAfterFile, "HSR/after");


        // Ø­Ø¯Ù‘Ø« Firestore Ø¥Ù† ÙƒØ§Ù† Ù…ØªØ§Ø­
        if (FIREBASE_READY) {
          await updateObservationInFirestore(currentSelectedObservation.docId, {
            status: 'COMPLETED',
            isComparative: true,
            afterImagePath: afterUrl,
            resolutionNote: note
          });
        }

        // Ø­Ø¯Ù‘Ø« Ù…Ø­Ù„ÙŠØ§Ù‹
        currentSelectedObservation.status = 'COMPLETED';
        currentSelectedObservation.isComparative = true;
        currentSelectedObservation.afterImagePath = afterUrl;
        currentSelectedObservation.resolutionNote = note;

        // Ø£ØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeModal('closeoutModal'); clearAfterUpload();
        handleFilterChange(); // Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
        showObservationDetail(currentSelectedObservation.docId);
        alert(`ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø±Ù‚Ù… ${currentSelectedObservation.id} ÙˆØªÙˆØ«ÙŠÙ‚Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!`);
      } catch (e) {
        console.error(e);
        alert('ØªØ¹Ø°Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
      } finally {
        setButtonBusy('finalCloseoutBtn', false);
        renderKPIs();
      }
    };

    // =============================
    // 6) Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø±Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ
    // =============================
    window.setupImageComparison = function(){
      const wrapper = document.getElementById('imageComparisonWrapper');
      const divider = document.getElementById('comparisonDivider');
      const afterImageContainer = document.getElementById('afterImageContainer');
      if (!wrapper) return;
      afterImageContainer.style.width = '50%'; divider.style.left = '50%';
      let isDragging = false;
      const onMove = (clientX)=>{
        if(!isDragging) return;
        const r = wrapper.getBoundingClientRect();
        let left = Math.max(0, Math.min(clientX - r.left, r.width));
        divider.style.left = `${left}px`; afterImageContainer.style.width = `${left}px`;
      };
      const onMouseMove = e=>onMove(e.clientX);
      const onTouchMove = e=>onMove(e.touches[0].clientX);
      const onMouseUp = ()=>{
        isDragging=false; wrapper.classList.remove('dragging');
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('touchmove', onTouchMove);
        window.removeEventListener('mouseup', onMouseUp);
        window.removeEventListener('touchend', onMouseUp);
      };
      const onMouseDown = e=>{
        e.preventDefault(); isDragging=true; wrapper.classList.add('dragging');
        onMove(e.clientX || (e.touches&&e.touches[0].clientX));
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('touchmove', onTouchMove);
        window.addEventListener('mouseup', onMouseUp);
        window.addEventListener('touchend', onMouseUp);
      };
      divider.addEventListener('mousedown', onMouseDown);
      divider.addEventListener('touchstart', onMouseDown);
      wrapper.addEventListener('mousedown', onMouseDown);
      wrapper.addEventListener('touchstart', onMouseDown);
    };

    window.analyzeImage = function(tool){
      const title = {'vision':'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¤ÙŠØ© (Vision)','root-cause':'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ'}[tool] || 'Ø§Ù„ØªØ­Ù„ÙŠÙ„';
      setText('aiResultTitle', `Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° ${title}...`);
      setHTML('aiResultContent', `<div class="flex items-center text-teal-700 font-bold"><div class="loading-spinner" style="border-top-color: var(--color-teal); border: 4px solid rgba(24, 165, 162, 0.3); margin-left: 8px;"></div> ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>`);
      unhide('aiResultContainer');
      setTimeout(()=>{
        let result = (tool==='vision')
          ? `<p class="communication-draft">**ÙˆØµÙ ØªÙ‚Ø±ÙŠØ¨ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ:** ØªØ¸Ù‡Ø± Ù…Ø¤Ø´Ø±Ø§Øª ØªÙ„Ù/ØªØ´Ù‚Ù‚Ø§Øª. ÙŠÙÙˆØµÙ‰ Ø¨Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…ØªØ¶Ø±Ø± ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³ÙÙ„ØªØ©.</p>`
          : `<p class="communication-draft">**5 Whys (Ù…Ù‚ØªØ±Ø­):**\n1) Ù„Ù…Ø§Ø°Ø§ Ø­Ø¯Ø«ØŸ ØªØ£Ø®Ø± ØµÙŠØ§Ù†Ø©.\n2) Ù„Ù…Ø§Ø°Ø§ØŸ Ù†Ù‚Øµ Ù…ØªØ§Ø¨Ø¹Ø©.\n3) Ù„Ù…Ø§Ø°Ø§ØŸ Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…Ø­Ø¯Ø«.\n4) Ù„Ù…Ø§Ø°Ø§ØŸ Ø¨Ø¯ÙˆÙ† Ø£ØªÙ…ØªØ©.\n5) Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ: ØºÙŠØ§Ø¨ Ø¢Ù„ÙŠØ© ØªÙ†Ø¨ÙŠÙ‡ Ø¯ÙˆØ±ÙŠ.</p>`;
        setText('aiResultTitle', `Ù†ØªØ§Ø¦Ø¬ ${title} Ù…ÙƒØªÙ…Ù„Ø©:`); setHTML('aiResultContent', result);
      }, 1200);
    };

    window.generateCommunicationDraft = function(){
      setText('aiResultTitle','ØµÙŠØ§ØºØ© Ø£Ù…Ø± Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¢Ù„ÙŠ...');
      setHTML('aiResultContent', `<div class="flex items-center text-teal-700 font-bold"><div class="loading-spinner" style="border-top-color: var(--color-teal); border: 4px solid rgba(24, 165, 162, 0.3); margin-left: 8px;"></div> ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>`);
      unhide('aiResultContainer');
      setTimeout(()=>{
        const o = currentSelectedObservation || {};
        setText('aiResultTitle','ØµÙŠØ§ØºØ© Ø£Ù…Ø± Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¢Ù„ÙŠ (Ù…ÙƒØªÙ…Ù„Ø©):');
        setHTML('aiResultContent', `
          <div class="communication-draft p-4 border rounded-lg">
            <p class="font-bold text-lg mb-2 text-red-800">Ø£Ù…Ø± Ø¹Ù…Ù„ Ø¹Ø§Ø¬Ù„: Ù…Ø¹Ø§Ù„Ø¬Ø© ${escapeHTML(o.title||'â€”')} [ID: ${o.id||'â€”'}]</p>
            <p class="mt-3 font-bold text-sm text-red-600">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${o.riskAssessment?.priority||'-'} | Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: ${o.riskAssessment?.timeframe||'-'}</p>
          </div>`);
      }, 900);
    };

    window.generateKpiInsights = function(){
      const { openReports } = kpis();
      setHTML('kpi-insight-result', `
        <div class="kpi-insight-container p-4 mt-4 bg-white">
          <p class="font-bold text-lg text-teal-700">Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ:</p>
          <p class="text-gray-700 mt-2">
            ÙŠÙˆØ¬Ø¯ ${openReports} Ù…Ù„Ø§Ø­Ø¸Ø© Ù…ÙØªÙˆØ­Ø©. Ù†ÙˆØµÙŠ Ø¨ØªØ³Ø±ÙŠØ¹ ØªÙˆØ«ÙŠÙ‚ ØµÙˆØ± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø²Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬ÙˆØ¯Ø©.
          </p>
        </div>`);
    };

    window.generatePdfReport = function(){ window.print(); };

    window.smartLogout = function(){
      const button = document.getElementById('logout-btn');
      button.disabled = true;
      button.innerHTML = '<div class="loading-spinner" style="border-top:4px solid var(--color-teal);"></div> Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...';
      button.classList.add('flex-row-reverse','justify-center'); button.style.backgroundColor='gray';
      setTimeout(()=>{ alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.'); window.location.href='login.html'; }, 800);
    };

    // =============================
    // 7) Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© UI
    // =============================
    function setText(id, text){ const el=document.getElementById(id); if(el) el.textContent = text ?? ''; }
    function setHTML(id, html){ const el=document.getElementById(id); if(el) el.innerHTML = html ?? ''; }
    function hide(id){ const el=document.getElementById(id); if(el) el.classList.add('hidden'); }
    function unhide(id){ const el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
    function toggleHidden(id, cond){ const el=document.getElementById(id); if(el) cond?el.classList.add('hidden'):el.classList.remove('hidden'); }
    function loaderHTML(msg){ return `<div class="text-center py-10"><div class="loading-spinner" style="border-top-color: var(--color-teal); border: 4px solid rgba(24,165,162,.3); margin:0 auto; width:40px; height:40px;"></div><p class="mt-4 text-xl font-extrabold text-teal-700">${msg}</p></div>`; }
    function successHTML(msg){ return `<div class="p-6 bg-green-50 rounded-xl border-4 border-green-200 text-center"><i data-lucide="check-circle" class="w-10 h-10 mx-auto text-green-600 mb-3"></i><h4 class="text-2xl font-extrabold text-green-700">${msg}</h4></div>`; }
    function errorHTML(msg){ return `<div class="p-6 bg-red-50 rounded-xl border-4 border-red-200 text-center"><i data-lucide="x-circle" class="w-10 h-10 mx-auto text-red-600 mb-3"></i><h4 class="text-2xl font-extrabold text-red-700">${msg}</h4></div>`; }
    function escapeHTML(str){ return (str||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function cryptoRandom(){ return (crypto.getRandomValues(new Uint32Array(2)).join('')); }

    // ÙˆØ¶Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ø­Ù„ÙŠ (ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø¶Ø¨Ø· Firebase)
    function seedLocalDemo(){
      observationsData = [
        { docId:'local-4', id:4, type:'QUALITY', date:'2024-09-20', title:'ØªØ¢ÙƒÙ„ ÙÙŠ Ù„ÙˆØ­Ø© Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© (Ø§Ù„Ø´Ø¹Ø§Ø± ØºÙŠØ± ÙˆØ§Ø¶Ø­)', status:'PENDING', details:'ØªØ¢ÙƒÙ„ ÙˆØ§Ø¶Ø­ Ø¨Ù„ÙˆØ­Ø© Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©.', hasImage:true, isComparative:false, location:'24.5247, 46.7135', isVideo:false, imagePath:'https://picsum.photos/800/600?random=4', fileMimeType:'image/jpeg', actionPlan:'Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù„ÙˆØ­Ø©.', riskAssessment:{priority:'High', timeframe:'7 days'}, resolutionNote:null, afterImagePath:null, createdAt: new Date("2024-09-20T16:45:00").getTime(), isNewInput:false },
        { docId:'local-2', id:2, type:'QUALITY', date:'2024-09-28', title:'ØªØµØ¯Ø¹ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø±ØµÙ', status:'COMPLETED', details:'ØªÙ… Ø¥ØºÙ„Ø§Ù‚Ù‡ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒØ§Ù…Ù„.', hasImage:true, isComparative:true, location:'24.5247, 46.7135', isVideo:false, imagePath:'https://picsum.photos/800/600?random=2', afterImagePath:'https://picsum.photos/800/600?random=5', fileMimeType:'image/jpeg', actionPlan:'Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª.', riskAssessment:{priority:'Low', timeframe:'7 days'}, resolutionNote:'ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª.', createdAt: new Date("2024-09-28T14:30:00").getTime(), isNewInput:false },
        { docId:'local-3', id:3, type:'MAINTENANCE', date:'2024-09-25', title:'Ø¹Ø·Ù„ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨Ø±ÙŠØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', status:'IN_PROGRESS', details:'Ø¥Ø±Ø³Ø§Ù„ ÙØ±ÙŠÙ‚ Ø¹Ø§Ø¬Ù„.', hasImage:true, isComparative:false, location:'24.5247, 46.7135', isVideo:false, imagePath:'https://picsum.photos/800/600?random=3', fileMimeType:'image/jpeg', actionPlan:'ØªÙˆÙÙŠØ± Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±.', riskAssessment:{priority:'Medium', timeframe:'48 hours'}, resolutionNote:null, afterImagePath:null, createdAt: new Date("2024-09-25T08:15:00").getTime(), isNewInput:false },
        { docId:'local-1', id:1, type:'SAFETY', date:'2024-10-01', title:'Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ø¯Ù… Ø§Ø±ØªØ¯Ø§Ø¡ Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø­Ù…Ø§ÙŠØ©', status:'PENDING', details:'ÙØ±ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† Ø®ÙˆØ°Ø§Øª Ø£Ù…Ø§Ù†.', hasImage:true, isComparative:false, location:'24.5247, 46.7135', isVideo:false, imagePath:'https://picsum.photos/800/600?random=1', fileMimeType:'image/jpeg', actionPlan:'ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù€ PPE.', riskAssessment:{priority:'High', timeframe:'24 hours'}, resolutionNote:null, afterImagePath:null, createdAt: new Date("2024-10-01T10:00:00").getTime(), isNewInput:false }
      ].sort((a,b)=>b.createdAt-a.createdAt);
    }

    // =============================
    // 8) Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    // =============================
    async function initApp(){
      try {
        await loadFromFirestore();
      } catch (e) {
        console.warn('Loading from Firestore failed, fallback to local demo.', e);
        seedLocalDemo();
      }
      // Ø¹Ø±Ø¶
      renderKPIs();
      observationsData.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
      renderObservationsList(observationsData);
      if (observationsData.length>0) showObservationDetail(observationsData[0].docId);
      lucide.createIcons();
    }
    window.onload = initApp;

        window.onload = initApp;

// =============================
// Ø£Ø¯Ø§Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
// =============================
function setButtonBusy(buttonId, busy) {
  const btn = document.getElementById(buttonId);
  if (!btn) return;
  if (busy) {
    btn.disabled = true;
    btn.innerHTML = `
      <div class="loading-spinner" 
           style="border-top:4px solid var(--color-teal);
                  width:20px;height:20px;
                  margin-inline-end:8px;"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...`;
    btn.classList.add('flex','items-center','justify-center','gap-2');
  } else {
    btn.disabled = false;
    btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚';
    btn.classList.remove('flex','items-center','justify-center','gap-2');
  }
}

  </script>
  
  <script src="modal-script.js"></script>


  <script>
// ===== ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© GPS ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± =====
function updateGpsStatus() {
  const gpsCircle = document.querySelector("#gpsIndicator .circle");
  const gpsText = document.getElementById("gpsText");

  if (!navigator.geolocation) {
    gpsText.textContent = "ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…";
    gpsCircle.classList.add("off");
    gpsCircle.classList.remove("on");
    return;
  }

  gpsText.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...";
  gpsCircle.classList.add("off");
  gpsCircle.classList.remove("on");

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      gpsText.textContent = "Ù†Ø´Ø·";
      gpsCircle.classList.add("on");
      gpsCircle.classList.remove("off");
    },
    (err) => {
      gpsText.textContent = "ØºÙŠØ± Ù…ØªØ§Ø­";
      gpsCircle.classList.add("off");
      gpsCircle.classList.remove("on");
    },
    { enableHighAccuracy: true, timeout: 5000 }
  );
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener("DOMContentLoaded", () => {
  updateGpsStatus();
});

// Ø¥Ø¹Ø§Ø¯Ø© ÙØ­Øµ GPS ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
setInterval(updateGpsStatus, 60000);
</script>

  
</body>
</html>
