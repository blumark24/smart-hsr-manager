<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Smart HSR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet"/>
  <style>
    body{font-family:'Tajawal',sans-serif;background:linear-gradient(180deg,#0b2b3a,#0ea5a1);min-height:100vh;color:#fff}
    .card{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:20px;backdrop-filter:blur(14px)}
    .btn{background:linear-gradient(90deg,#0ea5a1,#0b2b3a);color:#fff;font-weight:800;border-radius:999px;padding:.7rem 1.6rem;transition:.3s;box-shadow:0 4px 10px rgba(0,0,0,.2)}
    .btn:hover{transform:translateY(-2px) scale(1.02);box-shadow:0 10px 20px rgba(14,165,161,.4)}
    .btn-secondary{background:#0b2b3a;border:1px solid #0ea5a1}
    .btn-secondary:hover{background:#0ea5a1;border:1px solid #0ea5a1}
    .input-dark{background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);color:#fff}
    .input-dark::placeholder{color:rgba(255,255,255,.5)}
    .modal-content{background:#fff;color:#0b2b3a;border-radius:20px;padding:2rem;width:95%;max-width:56rem}
    .scrollbox::-webkit-scrollbar{width:8px}
    .scrollbox::-webkit-scrollbar-thumb{background-color:#0ea5a1;border-radius:10px}
    .scrollbox::-webkit-scrollbar-track{background:rgba(255,255,255,.1)}
    .badge{padding:.25rem .6rem;border-radius:999px;font-size:.7rem;font-weight:800;white-space:nowrap}
  </style>
</head>
<body>
  <!-- Toasts -->
  <div id="toastHost" class="fixed bottom-4 right-4 z-[120] space-y-2"></div>
  <audio id="sndNew" src="https://assets.mixkit.co/active_storage/sfx/1101/1101-preview.mp3" preload="auto"></audio>
  <audio id="sndUrgent" src="https://assets.mixkit.co/active_storage/sfx/2770/2770-preview.mp3" preload="auto"></audio>
  <audio id="sndClosed" src="https://assets.mixkit.co/active_storage/sfx/166/166-preview.mp3" preload="auto"></audio>

  <!-- Image Modal -->
  <div id="imageModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[110] p-4">
    <div class="relative max-w-4xl w-full">
      <button id="closeImageModal" class="absolute -top-10 left-0 btn btn-secondary px-4 py-2">Ø¥ØºÙ„Ø§Ù‚</button>
      <div id="imageCarousel" class="bg-white rounded-2xl p-2">
        <img id="previewImg" src="" class="w-full h-[70vh] object-contain rounded-xl" alt="preview"/>
      </div>
      <div id="thumbs" class="flex gap-2 mt-3 overflow-x-auto"></div>
    </div>
  </div>

  <!-- Message Modal -->
  <div id="messageModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-[100]">
    <div id="messageBox" class="card p-8 w-full max-w-lg text-center transform transition-all duration-300 scale-95 opacity-0">
      <h3 id="messageTitle" class="text-2xl font-black mb-3 text-teal-300"></h3>
      <p id="messageText" class="text-white/80 mb-6"></p>
      <button id="closeMessageModal" class="btn">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/10 backdrop-blur-xl border-b border-white/20">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-white/90 flex items-center justify-center text-[#0b2b3a] font-extrabold text-xl shadow-lg">SH</div>
        <h1 class="text-lg font-extrabold">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© <span class="text-teal-300">Smart HSR</span></h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnToggleNoti" class="btn btn-secondary text-sm px-4">ğŸ”” ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>
        <button id="logoutBtn" class="btn shadow-none bg-transparent border border-white/30 hover:bg-white/10 text-sm">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8 space-y-10">
    <div id="loadingIndicator" class="text-center p-8 text-xl font-bold bg-white/10 card hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <!-- KPIs (Smart Reports quick tiles) -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="card p-6 text-center shadow-2xl">
        <div class="text-sm opacity-70">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div>
        <div id="kpiNew" class="text-4xl font-extrabold mt-1 text-teal-300">0</div>
      </div>
      <div class="card p-6 text-center shadow-2xl">
        <div class="text-sm opacity-70">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</div>
        <div id="kpiDone" class="text-4xl font-extrabold mt-1 text-teal-300">0</div>
      </div>
      <div class="card p-6 text-center shadow-2xl">
        <div class="text-sm opacity-70">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©</div>
        <div id="kpiUrgent" class="text-4xl font-extrabold mt-1 text-red-300">0</div>
      </div>
      <div class="card p-6 text-center shadow-2xl">
        <div class="text-sm opacity-70">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
        <div id="kpiTotal" class="text-4xl font-extrabold mt-1 text-teal-300">0</div>
      </div>
    </section>

    <!-- Mini Chart -->
    <section class="card p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-2xl font-bold">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø°ÙƒÙŠØ©</h3>
        <select id="chartRange" class="input-dark p-2 rounded-xl">
          <option value="7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
          <option value="30" selected>Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</option>
          <option value="90">Ø¢Ø®Ø± 90 ÙŠÙˆÙ…</option>
        </select>
      </div>
      <canvas id="miniChart" width="800" height="260" class="w-full rounded-xl bg-white/5 border border-white/10"></canvas>
    </section>

    <!-- Notes -->
    <section class="card p-6 shadow-2xl">
      <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-4">
        <h3 class="text-2xl font-bold">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
        <div class="flex gap-2 w-full sm:w-auto">
          <select id="obsFilterType" class="input-dark p-3 rounded-xl">
            <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
            <option value="Ø·Ø±Ù‚">Ø·Ø±Ù‚</option>
            <option value="Ø£Ø±ØµÙØ©">Ø£Ø±ØµÙØ©</option>
            <option value="Ø¥Ù†Ø§Ø±Ø©">Ø¥Ù†Ø§Ø±Ø©</option>
            <option value="ØªØµØ±ÙŠÙ">ØªØµØ±ÙŠÙ</option>
          </select>
          <select id="obsFilterStatus" class="input-dark p-3 rounded-xl">
            <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="NEW">Ø¬Ø¯ÙŠØ¯Ø©</option>
            <option value="IN_PROGRESS">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
            <option value="COMPLETED">Ù…ØºÙ„Ù‚Ø©</option>
          </select>
        </div>
      </div>

      <div class="overflow-x-auto rounded-xl">
        <table class="w-full text-sm text-right border-collapse">
          <thead class="bg-white/10 sticky top-0">
            <tr class="text-white/80">
              <th class="p-3 border-b border-white/20">Ø±Ù‚Ù…</th>
              <th class="p-3 border-b border-white/20">Ø§Ù„Ù†ÙˆØ¹</th>
              <th class="p-3 border-b border-white/20">Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th class="p-3 border-b border-white/20">Ø¹Ø§Ø¬Ù„Ø©</th>
              <th class="p-3 border-b border-white/20">Ø§Ù„ÙˆØµÙ</th>
              <th class="p-3 border-b border-white/20">Ø§Ù„ØµÙˆØ±</th>
              <th class="p-3 border-b border-white/20">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹</th>
              <th class="p-3 border-b border-white/20">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="obsBody">
            <tr><td colspan="8" class="text-center p-4 text-white/60">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Users -->
    <section class="card p-6 shadow-2xl">
      <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-4">
        <h3 class="text-2xl font-bold">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h3>
        <div class="flex gap-2 w-full sm:w-auto">
          <input id="userSearch" type="text" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯" class="input-dark p-3 rounded-xl w-full sm:w-64">
          <button id="btnNewUser" class="btn">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
        </div>
      </div>
      <div class="overflow-x-auto rounded-xl">
        <table class="w-full text-sm text-right border-collapse">
          <thead class="bg-white/10 sticky top-0">
            <tr class="text-white/80">
              <th class="p-3 border-b border-white/20">Ø§Ù„Ø§Ø³Ù…</th>
              <th class="p-3 border-b border-white/20 hidden md:table-cell">Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
              <th class="p-3 border-b border-white/20">Ø§Ù„Ø¯ÙˆØ±</th>
              <th class="p-3 border-b border-white/20">Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th class="p-3 border-b border-white/20">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="usersBody">
            <tr><td colspan="5" class="text-center p-4 text-white/60">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- User Modal -->
  <div id="userModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
    <div class="modal-content relative">
      <button id="closeUserModal" class="absolute top-4 left-4 text-gray-500 hover:text-black">
        âœ•
      </button>
      <h2 class="text-2xl font-extrabold mb-6 text-center text-[#0b2b3a]">â• Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…</h2>
      <form id="userForm" class="space-y-5">
        <div><label class="block text-sm font-semibold mb-1">Ø§Ù„Ø§Ø³Ù…</label><input id="uName" required class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-[#0ea5a1]"></div>
        <div><label class="block text-sm font-semibold mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input id="uEmail" type="email" required class="w-full border border-gray-300 rounded-xl p-3"></div>
        <div><label class="block text-sm font-semibold mb-1">Ø§Ù„Ø¯ÙˆØ±</label>
          <select id="uRole" required class="w-full border border-gray-300 rounded-xl p-3">
            <option value="inspector">Ù…Ø±Ø§Ù‚Ø¨</option>
            <option value="contractor">Ù…Ù‚Ø§ÙˆÙ„</option>
          </select>
        </div>
        <div><label class="block text-sm font-semibold mb-1">Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="uStatus" required class="w-full border border-gray-300 rounded-xl p-3">
            <option value="active">Ù†Ø´Ø·</option>
            <option value="suspended">Ù…Ø¹Ù„Ù‘Ù‚</option>
          </select>
        </div>
        <div class="flex justify-center mt-6"><button type="submit" class="btn">ğŸ’¾ Ø­ÙØ¸</button></div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, query, onSnapshot, serverTimestamp, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
      getStorage, ref as sRef, getDownloadURL, listAll
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // ===== Config =====
    const firebaseConfig = {
      apiKey: "AIzaSyD5c-REPLACE-ME",
      authDomain: "smart-hsr-manager.firebaseapp.com",
      projectId: "smart-hsr-manager",
      storageBucket: "smart-hsr-manager.appspot.com",
      messagingSenderId: "000000000000",
      appId: "1:000000000000:web:REPLACE_ME"
    };

    const USERS_PATH = "users";                 // users/{id}
    const OBSERVATIONS_PATH = "observations";   // observations/{id}

    // ===== State =====
    let app, db, auth, storage;
    let usersData = [];
    let observationsData = [];
    let editingUserId = null;
    let userSearchTerm = '';
    let filterType = 'all';
    let filterStatus = 'all';
    let notiEnabled = JSON.parse(localStorage.getItem('smart_hsr_noti') || 'false');

    const prevObs = new Map(); // id -> {status, urgent}

    // ===== DOM =====
    const loadingIndicator = document.getElementById('loadingIndicator');
    const logoutBtn = document.getElementById('logoutBtn');
    const btnToggleNoti = document.getElementById('btnToggleNoti');

    const kpiNew = document.getElementById('kpiNew');
    const kpiDone = document.getElementById('kpiDone');
    const kpiUrgent = document.getElementById('kpiUrgent');
    const kpiTotal = document.getElementById('kpiTotal');

    const chartRange = document.getElementById('chartRange');
    const chartCanvas = document.getElementById('miniChart');

    const obsBody = document.getElementById('obsBody');
    const obsFilterType = document.getElementById('obsFilterType');
    const obsFilterStatus = document.getElementById('obsFilterStatus');

    const usersBody = document.getElementById('usersBody');
    const userSearch = document.getElementById('userSearch');
    const btnNewUser = document.getElementById('btnNewUser');

    const userModal = document.getElementById('userModal');
    const closeUserModal = document.getElementById('closeUserModal');
    const userForm = document.getElementById('userForm');
    const uName = document.getElementById('uName');
    const uEmail = document.getElementById('uEmail');
    const uRole = document.getElementById('uRole');
    const uStatus = document.getElementById('uStatus');

    const toastHost = document.getElementById('toastHost');
    const sndNew = document.getElementById('sndNew');
    const sndUrgent = document.getElementById('sndUrgent');
    const sndClosed = document.getElementById('sndClosed');

    const imageModal = document.getElementById('imageModal');
    const closeImageModal = document.getElementById('closeImageModal');
    const previewImg = document.getElementById('previewImg');
    const thumbs = document.getElementById('thumbs');

    // ===== UI helpers =====
    function setNotiBtn(){
      btnToggleNoti.textContent = notiEnabled ? 'ğŸ”• Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª' : 'ğŸ”” ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª';
    }
    function toast(text, type='info'){
      const base = document.createElement('div');
      base.className = 'rounded-xl px-4 py-3 shadow-lg border text-sm flex items-center gap-2 ' +
        (type==='success'?'bg-emerald-600/90 border-emerald-400':
         type==='danger'?'bg-red-600/90 border-red-400':
         type==='warn'?'bg-yellow-600/90 border-yellow-400':
         'bg-slate-700/90 border-slate-500');
      base.innerHTML = `<span>${text}</span>`;
      toastHost.appendChild(base);
      setTimeout(()=>{ base.classList.add('opacity-0','translate-y-2'); }, 3000);
      setTimeout(()=>{ base.remove(); }, 3600);
    }
    function desktopNotify(title, body){
      if (!notiEnabled) return;
      if (Notification.permission === 'granted'){
        new Notification(title,{ body });
      }
    }
    function play(soundEl){
      try{ soundEl.currentTime=0; soundEl.play(); }catch{}
    }

    // ===== KPI + Chart =====
    function updateKPIs(){
      const total = observationsData.length;
      const newC = observationsData.filter(o=>o.status==='NEW').length;
      const done = observationsData.filter(o=>o.status==='COMPLETED').length;
      const urgent = observationsData.filter(o=>o.urgent===true).length;
      kpiTotal.textContent = total;
      kpiNew.textContent = newC;
      kpiDone.textContent = done;
      kpiUrgent.textContent = urgent;
      drawMiniChart();
    }
    function drawMiniChart(){
      const days = parseInt(chartRange.value,10)||30;
      const since = new Date(Date.now()-days*24*60*60*1000);
      const inRange = observationsData.filter(o=>{
        const d = o.createdAt?.toDate ? o.createdAt.toDate() : (o.createdAt? new Date(o.createdAt): null);
        return d && d >= since;
      });
      const counts = {
        NEW: inRange.filter(o=>o.status==='NEW').length,
        IN_PROGRESS: inRange.filter(o=>o.status==='IN_PROGRESS').length,
        COMPLETED: inRange.filter(o=>o.status==='COMPLETED').length,
        URGENT: inRange.filter(o=>o.urgent===true).length,
      };
      const ctx = chartCanvas.getContext('2d');
      ctx.clearRect(0,0,chartCanvas.width, chartCanvas.height);
      const labels = ['Ø¬Ø¯ÙŠØ¯Ø©','Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°','Ù…ØºÙ„Ù‚Ø©','Ø¹Ø§Ø¬Ù„Ø©'];
      const values = [counts.NEW, counts.IN_PROGRESS, counts.COMPLETED, counts.URGENT];
      const W = chartCanvas.width, H = chartCanvas.height, pad = 40;
      const barW = (W - pad*2) / values.length * 0.6;
      const maxV = Math.max(1, ...values);
      // axis
      ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();
      // bars
      values.forEach((v,i)=>{
        const x = pad + (i+0.2)*((W - pad*2)/values.length);
        const h = (H - pad*2) * (v/maxV);
        ctx.fillStyle = 'rgba(45,200,195,0.9)';
        ctx.fillRect(x, H - pad - h, barW, h);
        ctx.fillStyle='white';
        ctx.textAlign='center';
        ctx.fillText(labels[i], x+barW/2, H - pad + 16);
        ctx.font='bold 14px Tajawal';
        ctx.fillText(String(v), x+barW/2, H - pad - h - 6);
      });
    }

    // ===== Render: Observations =====
    function renderObservations(){
      let list = observationsData.slice();
      if (filterType!=='all') list = list.filter(o=>o.type===filterType);
      if (filterStatus!=='all') list = list.filter(o=>o.status===filterStatus);
      if (list.length===0){
        obsBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-white/60">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</td></tr>`;
        return;
      }
      obsBody.innerHTML = list.map(o=>{
        const statusBadge = o.status==='COMPLETED'?'bg-green-500':(o.status==='IN_PROGRESS'?'bg-yellow-500':'bg-blue-500');
        const urgentBadge = o.urgent ? '<span class="badge bg-red-600">Ø¹Ø§Ø¬Ù„Ø©</span>' : '<span class="badge bg-slate-500/70">â€”</span>';
        const desc = (o.description||'-').slice(0,120);
        const dateStr = (()=>{ const d=o.createdAt?.toDate?o.createdAt.toDate(): (o.createdAt?new Date(o.createdAt):null); return d? d.toLocaleString('ar-SA'): '-';})();
        const locationStr = o.location?.address || (o.location? `${o.location.lat}, ${o.location.lng}` : '-');
        const imagesCount = (o.images?.inspector?.length||0)+(o.images?.contractor?.length||0)+(o.images?.manager?.length||0);
        const imgBtn = imagesCount>0 ? `<button class="text-xs underline" data-id="${o.id}" data-what="images">Ø¹Ø±Ø¶ (${imagesCount})</button>` : 'â€”';
        return `
          <tr class="hover:bg-white/10 transition">
            <td class="p-3 font-mono">${o.id||'-'}</td>
            <td class="p-3">${o.type||'-'}</td>
            <td class="p-3"><span class="badge ${statusBadge}">${o.status==='NEW'?'Ø¬Ø¯ÙŠØ¯Ø©':(o.status==='IN_PROGRESS'?'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°':'Ù…ØºÙ„Ù‚Ø©')}</span></td>
            <td class="p-3">${urgentBadge}</td>
            <td class="p-3 max-w-[360px]">${desc}</td>
            <td class="p-3">${imgBtn}</td>
            <td class="p-3"><div>${dateStr}</div><div class="text-white/70 text-xs">${locationStr}</div></td>
            <td class="p-3 flex flex-wrap gap-2 items-center">
              <button class="text-xs text-white bg-teal-600 hover:bg-teal-500 px-2 py-1 rounded-full" data-id="${o.id}" data-what="progress">ğŸ› ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>
              <button class="text-xs text-yellow-300 hover:text-yellow-200" data-id="${o.id}" data-what="urgent">ğŸš¨ Ø±ÙØ¹Ù‡Ø§ ÙƒÙ€ Ø¹Ø§Ø¬Ù„Ø©</button>
              <button class="text-xs text-green-300 hover:text-green-200" data-id="${o.id}" data-what="close">âœ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
              <button class="text-xs text-red-300 hover:text-red-200" data-id="${o.id}" data-what="delete">ğŸ—‘ï¸ Ø­Ø°ÙÙ‡Ø§</button>
            </td>
          </tr>`;
      }).join('');
      // bind
      obsBody.querySelectorAll('button').forEach(b=>{
        const id=b.dataset.id; const what=b.dataset.what;
        b.onclick=()=> {
          if (what==='progress') cycleStatus(id);
          if (what==='urgent') markUrgent(id);
          if (what==='close') closeObservation(id);
          if (what==='delete') deleteObservation(id);
          if (what==='images') openImages(id);
        };
      });
    }

    async function cycleStatus(id){
      const o = observationsData.find(x=>x.id===id); if(!o) return;
      const next = o.status==='NEW'?'IN_PROGRESS':(o.status==='IN_PROGRESS'?'COMPLETED':'NEW');
      await updateDoc(doc(db, OBSERVATIONS_PATH, id), { status: next, updatedAt: serverTimestamp() });
      toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'success');
    }
    async function markUrgent(id){
      await updateDoc(doc(db, OBSERVATIONS_PATH, id), { urgent: true, updatedAt: serverTimestamp() });
      toast('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙƒØ¹Ø§Ø¬Ù„Ø©', 'warn');
    }
    async function closeObservation(id){
      await updateDoc(doc(db, OBSERVATIONS_PATH, id), { status: 'COMPLETED', updatedAt: serverTimestamp(), closedAt: serverTimestamp() });
      toast('ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©', 'success');
    }
    async function deleteObservation(id){
      if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ')) return;
      await deleteDoc(doc(db, OBSERVATIONS_PATH, id));
      toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©', 'danger');
    }

    // Images (Firestore + Storage)
    async function openImages(id){
      const o = observationsData.find(x=>x.id===id); if(!o) return;
      const paths = []
        .concat(o.images?.inspector||[])
        .concat(o.images?.contractor||[])
        .concat(o.images?.manager||[]);
      const urls = [];
      for (const p of paths){
        try{
          // allow direct URLs or storage paths
          if (/^https?:\/\//.test(p)) { urls.push(p); continue; }
          const u = await getDownloadURL(sRef(storage, p));
          urls.push(u);
        }catch{}
      }
      if (urls.length===0){ toast('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±', 'info'); return; }
      thumbs.innerHTML = '';
      previewImg.src = urls[0];
      urls.forEach((u,idx)=>{
        const t = document.createElement('img');
        t.src = u; t.alt='thumb';
        t.className='w-20 h-20 object-cover rounded-lg cursor-pointer border border-white/20';
        t.onclick=()=>{ previewImg.src = u; };
        thumbs.appendChild(t);
      });
      imageModal.classList.remove('hidden'); imageModal.classList.add('flex');
    }
    closeImageModal.onclick = ()=>{ imageModal.classList.add('hidden'); imageModal.classList.remove('flex'); };

    // ===== Render: Users =====
    function renderUsers(){
      const filtered = usersData.filter(u=>{
        const q=(userSearchTerm||'').toLowerCase();
        return (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q);
      });
      if (filtered.length===0){
        usersBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-white/60">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø·Ø§Ø¨Ù‚ÙˆÙ†.</td></tr>`;
        return;
      }
      usersBody.innerHTML = filtered.map(u=>{
        const badge = u.status==='active'?'bg-green-500':'bg-gray-500';
        const roleTxt = u.role==='inspector'?'Ù…Ø±Ø§Ù‚Ø¨':'Ù…Ù‚Ø§ÙˆÙ„';
        return `
          <tr class="hover:bg-white/10 transition">
            <td class="p-3">${u.name||'-'}</td>
            <td class="p-3 hidden md:table-cell text-white/70">${u.email||'-'}</td>
            <td class="p-3">${roleTxt}</td>
            <td class="p-3"><span class="px-3 py-1 text-xs font-semibold rounded-full ${badge}">${u.status==='active'?'Ù†Ø´Ø·':'Ù…Ø¹Ù„Ù‘Ù‚'}</span></td>
            <td class="p-3 flex gap-2 items-center">
              <button class="text-xs text-white bg-teal-600 hover:bg-teal-500 px-2 py-1 rounded-full" data-id="${u.id}" data-action="edit">âœ ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="text-xs text-red-300 hover:text-red-200" data-id="${u.id}" data-action="delete">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              <button class="text-xs text-yellow-300 hover:text-yellow-200" data-id="${u.id}" data-action="toggle">${u.status==='active'?'ØªØ¹Ø·ÙŠÙ„':'ØªÙØ¹ÙŠÙ„'}</button>
            </td>
          </tr>`;
      }).join('');
      usersBody.querySelectorAll('button').forEach(btn=>{
        const id=btn.dataset.id; const action=btn.dataset.action;
        btn.onclick= async ()=>{
          const user = usersData.find(x=>x.id===id);
          if (!user) return;
          if (action==='edit') openUserModal(user);
          if (action==='delete'){ if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return; await deleteDoc(doc(db, USERS_PATH, id)); toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'danger'); }
          if (action==='toggle'){ const ns = user.status==='active'?'suspended':'active'; await updateDoc(doc(db, USERS_PATH, id), { status:ns, updatedAt:serverTimestamp() }); toast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'success'); }
        };
      });
    }

    function openUserModal(user){
      editingUserId = user? user.id : null;
      uName.value = user?.name||'';
      uEmail.value = user?.email||'';
      uRole.value = user?.role||'inspector';
      uStatus.value = user?.status||'active';
      userModal.classList.remove('hidden'); userModal.classList.add('flex');
    }
    function closeUser(){ userModal.classList.add('hidden'); userModal.classList.remove('flex'); }
    userForm.onsubmit = async (e)=>{
      e.preventDefault();
      const payload = {
        name: uName.value.trim(),
        email: uEmail.value.trim(),
        role: uRole.value,
        status: uStatus.value,
        updatedAt: serverTimestamp()
      };
      if (editingUserId){
        await updateDoc(doc(db, USERS_PATH, editingUserId), payload);
        toast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'success');
      }else{
        const id = 'usr_'+Date.now();
        await setDoc(doc(db, USERS_PATH, id), { ...payload, createdAt: serverTimestamp(), id });
        toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…', 'success');
      }
      closeUser();
    };
    closeUserModal.onclick = closeUser;

    // ===== Notifications =====
    function askPermissionIfNeeded(){
      if (notiEnabled && Notification && Notification.permission !== 'granted'){
        Notification.requestPermission().then(p=>{
          if (p!=='granted'){ notiEnabled=false; localStorage.setItem('smart_hsr_noti','false'); setNotiBtn(); toast('ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'warn'); }
        });
      }
    }
    btnToggleNoti.onclick = ()=>{
      notiEnabled = !notiEnabled;
      localStorage.setItem('smart_hsr_noti', JSON.stringify(notiEnabled));
      setNotiBtn();
      if (notiEnabled) { askPermissionIfNeeded(); toast('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', 'success'); } else { toast('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', 'warn'); }
    };
    setNotiBtn();

    // Fire basis for change detection & notifications
    function handleObservationEvents(newList){
      const byId = new Map(newList.map(o=>[o.id,o]));
      // New items
      for (const [id, o] of byId){
        const before = prevObs.get(id);
        if (!before){
          if (notiEnabled){ play(sndNew); desktopNotify('Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©', `#${id} - ${o.type||''}`); }
          toast(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø© (#${id})`, 'info');
        }else{
          if (!before.urgent && o.urgent){
            if (notiEnabled){ play(sndUrgent); desktopNotify('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙƒØ¹Ø§Ø¬Ù„Ø©', `#${id}`); }
            toast(`ğŸš¨ Ù…Ù„Ø§Ø­Ø¸Ø© (#${id}) Ø£ØµØ¨Ø­Øª Ø¹Ø§Ø¬Ù„Ø©`, 'warn');
          }
          if (before.status!=='COMPLETED' && o.status==='COMPLETED'){
            if (notiEnabled){ play(sndClosed); desktopNotify('ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù…Ù„Ø§Ø­Ø¸Ø©', `#${id}`); }
            toast(`âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© (#${id})`, 'success');
          }
        }
      }
      // Update snapshot
      prevObs.clear();
      for (const [id,o] of byId){ prevObs.set(id, { status:o.status, urgent:!!o.urgent }); }
    }

    // ===== Auth + Realtime =====
    async function init(){
      loadingIndicator.classList.remove('hidden');
      app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); storage = getStorage(app);
      onAuthStateChanged(auth, async (user)=>{
        if(!user){ window.location.href='owner-login.html'; return; }
        const snap = await getDoc(doc(db,'managers', user.uid));
        if(!snap.exists() || snap.data().role!=='manager'){ await signOut(auth); window.location.href='owner-login.html'; return; }
        startRealtime(); loadingIndicator.classList.add('hidden');
        askPermissionIfNeeded();
      });
    }

    function startRealtime(){
      onSnapshot(query(collection(db, USERS_PATH)), (qs)=>{
        usersData=[]; qs.forEach(d=> usersData.push({ id:d.id, ...d.data() }));
        renderUsers();
      });
      onSnapshot(query(collection(db, OBSERVATIONS_PATH)), (qs)=>{
        observationsData=[]; qs.forEach(d=> observationsData.push({ id:d.id, ...d.data() }));
        renderObservations(); updateKPIs(); handleObservationEvents(observationsData);
      });
    }

    // ===== Simple filters/search/events =====
    obsFilterType.onchange = (e)=>{ filterType=e.target.value; renderObservations(); };
    obsFilterStatus.onchange = (e)=>{ filterStatus=e.target.value; renderObservations(); };
    chartRange.onchange = drawMiniChart;

    logoutBtn.onclick = async()=>{ await signOut(auth); window.location.href='owner-login.html' };
    btnNewUser.onclick = ()=> openUserModal();
    userSearch.oninput = (e)=>{ userSearchTerm=e.target.value.trim(); renderUsers(); };

    window.onload = init;
  </script>
</body>
</html>
