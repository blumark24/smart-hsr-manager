<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart HSR | Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©)</title>
  <meta name="description" content="Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø¨Ù„Ø§ØºØ§Øª ÙˆÙ…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„Ù†Ø¸Ø§Ù… Smart HSR"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet" />
  <style>
    :root{--color-navy:#0A1931;--color-teal:#18A5A2;--color-gray-bg:#F7F9FC}
    body{font-family:'Tajawal',sans-serif;background:var(--color-gray-bg);color:var(--color-navy)}
    .card{background:#fff;border-radius:1.5rem;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:1.25rem;border-top:5px solid var(--color-teal)}
    .kpi-card{border-radius:1.25rem;color:#fff;padding:1.25rem;display:flex;align-items:center;justify-content:space-between}
    .kpi-open{background:linear-gradient(135deg,#EF4444,#B91C1C)}
    .kpi-closed{background:linear-gradient(135deg,#10B981,#18A5A2)}
    .kpi-total{background:linear-gradient(135deg,#3B82F6,#0A1931)}
    .kpi-photo{background:linear-gradient(135deg,#8B5CF6,#0EA5A1)}
    .btn{background:var(--color-teal);color:#fff;border-radius:999px;padding:.55rem 1.1rem;font-weight:800;transition:.25s;box-shadow:0 6px 15px rgba(24,165,162,.35)}
    .btn:hover{background:#148f8c;transform:translateY(-1px)}
    .btn-ghost{background:#0A1931;color:#fff;border-radius:999px;padding:.55rem 1.1rem;font-weight:800}
    .tag{display:inline-block;border-radius:999px;padding:.2rem .7rem;font-size:.8rem;font-weight:800}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:50;align-items:center;justify-content:center}
    .modal-content{background:#fff;border-radius:1rem;max-width:720px;width:92%;padding:1.25rem;box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .table th,.table td{padding:.75rem;border-bottom:1px solid #e5e7eb}
    .pill{border-radius:999px;padding:.25rem .65rem;font-weight:800}
    .tab-active{background:#fff;border-top:5px solid var(--color-teal);border-radius:1rem 1rem 0 0}
    @media print{.no-print{display:none!important}}
  </style>
</head>
<body>
  <!-- Session Guard + Toast utilities -->
  <script>
    function showToast(msg){
      const t=document.getElementById('toast');
      if(!t) return; 
      t.textContent=msg; t.classList.remove('hidden'); t.style.opacity='1';
      setTimeout(()=>{ t.style.opacity='0'; },2200);
      setTimeout(()=>{ t.classList.add('hidden'); },2800);
    }
    (function(){
      const s=sessionStorage.getItem('smartHSRUser');
      if(!s){ window.location.href='manager-login.html'; return; }
      try{
        const user=JSON.parse(s)||{};
        const badge=document.getElementById('userBadge');
        if(badge){ badge.innerHTML = '<i data-lucide="user" class="w-4 h-4"></i> '+(user.email||'Ù…Ø¯ÙŠØ±'); badge.classList.remove('hidden'); }
        if(!sessionStorage.getItem('welcomed')){ showToast('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ â€“ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!'); sessionStorage.setItem('welcomed','1'); }
        try{ lucide.createIcons(); }catch(e){}
        window.__SMART_USER__ = user;
      }catch(e){ console.warn('Session parse failed',e); }
    })();
  </script>
  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-40 no-print">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      $1<span id="userBadge" class="hidden md:inline-flex items-center gap-2 bg-teal-50 text-teal-700 px-3 py-1 rounded-full text-xs font-bold"></span>
      <button id="logoutBtn" class="btn-ghost flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <!-- KPIs -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="kpi-card kpi-total"><div><p class="text-sm opacity-90">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p><p id="kpi-total" class="text-4xl font-extrabold">--</p></div><i data-lucide="clipboard-list" class="w-10 h-10 opacity-80"></i></div>
      <div class="kpi-card kpi-open"><div><p class="text-sm opacity-90">Ø¨Ù„Ø§ØºØ§Øª Ù…ÙØªÙˆØ­Ø©</p><p id="kpi-open" class="text-4xl font-extrabold">--</p></div><i data-lucide="alert-triangle" class="w-10 h-10 opacity-80"></i></div>
      <div class="kpi-card kpi-closed"><div><p class="text-sm opacity-90">Ø¨Ù„Ø§ØºØ§Øª Ù…ØºÙ„Ù‚Ø©</p><p id="kpi-closed" class="text-4xl font-extrabold">--</p></div><i data-lucide="check-circle" class="w-10 h-10 opacity-80"></i></div>
      <div class="kpi-card kpi-photo"><div><p class="text-sm opacity-90">Ù…ÙˆØ«Ù‚Ø© Ø¨Ø§Ù„ØµÙˆØ±</p><p id="kpi-photo" class="text-4xl font-extrabold">--</p></div><i data-lucide="image" class="w-10 h-10 opacity-80"></i></div>
    </section>

    <!-- Tabs -->
    <nav class="no-print">
      <ul class="flex gap-3 text-sm font-extrabold">
        <li><button class="px-4 py-2 tab-active" data-tab="users">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</button></li>
        <li><button class="px-4 py-2" data-tab="observations">Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</button></li>
        <li><button class="px-4 py-2" data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button></li>
        <li><button class="px-4 py-2" data-tab="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button></li>
      </ul>
    </nav>

    <!-- USERS TAB -->
    <section id="tab-users" class="mt-6">
      <div class="card">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <h2 class="text-2xl font-extrabold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
          <div class="flex items-center gap-2">
            <input id="userSearch" type="text" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯" class="border rounded-xl p-2 w-full md:w-64" oninput="filterUsers()"/>
            <button class="btn" onclick="openModal('modalAddUser')"><i data-lucide="user-plus" class="w-4 h-4 ml-1"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
          </div>
        </div>
        <div class="overflow-x-auto rounded-xl border">
          <table class="table w-full text-sm">
            <thead class="bg-gray-50">
              <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
            </thead>
            <tbody id="usersBody"><tr><td colspan="5" class="text-center p-6 text-gray-500">...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- OBSERVATIONS TAB -->
    <section id="tab-observations" class="mt-6 hidden">
      <div class="card">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <h2 class="text-2xl font-extrabold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h2>
          <div class="flex items-center gap-2">
            <select id="statusFilter" class="border rounded-xl p-2" onchange="renderObservations()">
              <option value="ALL">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
              <option value="PENDING">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
              <option value="IN_PROGRESS">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
              <option value="COMPLETED">Ù…ØºÙ„Ù‚</option>
            </select>
            <button class="btn" onclick="seedDemoData(true)"><i data-lucide="refresh-ccw" class="w-4 h-4 ml-1"></i> ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
          </div>
        </div>
        <div class="overflow-x-auto rounded-xl border">
          <table class="table w-full text-sm">
            <thead class="bg-gray-50">
              <tr><th>Ø§Ù„Ù…Ø¹Ø±Ù</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</th><th>Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù„Ø§Øº</th><th class="text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
            </thead>
            <tbody id="obsBody"><tr><td colspan="7" class="text-center p-6 text-gray-500">...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REPORTS TAB -->
    <section id="tab-reports" class="mt-6 hidden">
      <div class="card">
        <h2 class="text-2xl font-extrabold mb-4">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="p-4 rounded-xl border">
            <h3 class="font-extrabold mb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ (AI Demo)</h3>
            <p class="text-sm text-gray-600 mb-4">Ø§Ø¶ØºØ· Ù„ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ø®Øµ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ±Ù‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©.</p>
            <button class="btn" onclick="generateAiSummary()">âœ¨ ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± ØªÙ†ÙÙŠØ°ÙŠ</button>
            <div id="aiSummary" class="mt-4 text-sm bg-gray-50 rounded-xl p-3 hidden"></div>
          </div>
          <div class="p-4 rounded-xl border">
            <h3 class="font-extrabold mb-2">ØªØµØ¯ÙŠØ± ÙˆØ·Ø¨Ø§Ø¹Ø©</h3>
            <p class="text-sm text-gray-600 mb-4">ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒØªÙ‚Ø±ÙŠØ± PDF.</p>
            <button class="btn-ghost" onclick="window.print()"><i data-lucide="file-down" class="w-4 h-4 ml-1"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS TAB -->
    <section id="tab-settings" class="mt-6 hidden">
      <div class="card">
        <h2 class="text-2xl font-extrabold mb-4">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
        <div class="flex flex-col gap-3">
          <label class="flex items-center gap-2"><input id="darkToggle" type="checkbox" class="w-4 h-4" onchange="toggleDarkMode()"> ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠ)</label>
          <button class="btn w-fit" onclick="seedDemoData(true)"><i data-lucide="database" class="w-4 h-4 ml-1"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
        </div>
      </div>
    </section>
  </main>

  <!-- MODALS -->
  <div id="modalAddUser" class="modal">
    <div class="modal-content">
      <div class="flex items-center justify-between border-b pb-2 mb-3">
        <h3 class="text-xl font-extrabold">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <button class="text-2xl" onclick="closeModal('modalAddUser')">&times;</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm font-bold">Ø§Ù„Ø§Ø³Ù…</label>
          <input id="addName" class="border rounded-xl p-2 w-full" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯"/>
        </div>
        <div>
          <label class="text-sm font-bold">Ø§Ù„Ø¨Ø±ÙŠØ¯</label>
          <input id="addEmail" class="border rounded-xl p-2 w-full" placeholder="ahmed@example.com"/>
        </div>
        <div>
          <label class="text-sm font-bold">Ø§Ù„Ø¯ÙˆØ±</label>
          <select id="addRole" class="border rounded-xl p-2 w-full">
            <option value="manager">Ù…Ø¯ÙŠØ±</option>
            <option value="inspector">Ù…Ø±Ø§Ù‚Ø¨</option>
            <option value="contractor">Ù…Ù‚Ø§ÙˆÙ„</option>
          </select>
        </div>
        <div class="flex items-end"><button class="btn" onclick="saveUser()">Ø­ÙØ¸</button></div>
      </div>
    </div>
  </div>

  <div id="modalAssign" class="modal">
    <div class="modal-content">
      <div class="flex items-center justify-between border-b pb-2 mb-3">
        <h3 class="text-xl font-extrabold">ğŸ§­ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ù„Ø§Øº</h3>
        <button class="text-2xl" onclick="closeModal('modalAssign')">&times;</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm font-bold">Ø§Ø®ØªØ± Ù…Ø±Ø§Ù‚Ø¨</label>
          <select id="assignInspector" class="border rounded-xl p-2 w-full"></select>
        </div>
        <div>
          <label class="text-sm font-bold">Ø§Ø®ØªØ± Ù…Ù‚Ø§ÙˆÙ„</label>
          <select id="assignContractor" class="border rounded-xl p-2 w-full"></select>
        </div>
        <div class="flex items-end"><button class="btn" onclick="confirmAssign()">ØªØ¹ÙŠÙŠÙ†</button></div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script>
    // ===== State =====
    let users = [];
    let observations = [];
    let selectedObservationId = null;

    const statusLabels = { PENDING:'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', IN_PROGRESS:'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', COMPLETED:'Ù…ØºÙ„Ù‚' };
    const statusColors = { PENDING:'bg-red-600 text-white', IN_PROGRESS:'bg-yellow-500 text-black', COMPLETED:'bg-green-600 text-white' };

    // ===== Utils =====
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const openModal = id => { document.getElementById(id).style.display='flex'; }
    const closeModal = id => { document.getElementById(id).style.display='none'; }

    // ===== Tabs =====
    $$("nav [data-tab]").forEach(btn=>{
      btn.addEventListener('click',()=>{
        $$("nav [data-tab]").forEach(b=>b.classList.remove('tab-active'));
        btn.classList.add('tab-active');
        const t = btn.getAttribute('data-tab');
        ['users','observations','reports','settings'].forEach(id=>{
          document.getElementById('tab-'+id).classList.toggle('hidden', id!==t);
        });
      })
    });

    // ===== Demo Seed =====
    function seedDemoData(reset=false){
      if(!users.length || reset){
        users = [
          {id:'u1', name:'Ø£Ø­Ù…Ø¯ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ', email:'ahmed@example.com', role:'inspector', active:true},
          {id:'u2', name:'Ù†ÙˆØ±Ø© Ø§Ù„Ø³Ø¨ÙŠØ¹ÙŠ', email:'nora@example.com', role:'inspector', active:true},
          {id:'u3', name:'Ø´Ø±ÙƒØ© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…ØªØ­Ø¯Ø©', email:'cont@example.com', role:'contractor', active:true},
          {id:'u4', name:'Ù…Ø´Ø±Ù Ø¹Ø§Ù…', email:'manager@example.com', role:'manager', active:true},
        ];
      }
      if(!observations.length || reset){
        observations = [
          {id:1761488503202, title:'Ø­ÙØ±ÙŠØ© Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚', status:'PENDING', inspector:'Ø£Ø­Ù…Ø¯ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ', contractor:'â€”', date:'2025-10-29', hasImage:true},
          {id:1761488503203, title:'Ø­ÙˆØ§Ø¬Ø² Ø®Ø±Ø³Ø§Ù†ÙŠØ© Ù…ØªØ³Ø§Ù‚Ø·Ø©', status:'PENDING', inspector:'Ù†ÙˆØ±Ø© Ø§Ù„Ø³Ø¨ÙŠØ¹ÙŠ', contractor:'â€”', date:'2025-10-29', hasImage:true},
          {id:1761488503204, title:'ØªØ´Ù‚Ù‚Ø§Øª Ø¨Ø§Ù„Ø£Ø³ÙÙ„Øª', status:'IN_PROGRESS', inspector:'Ø£Ø­Ù…Ø¯ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ', contractor:'Ø´Ø±ÙƒØ© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…ØªØ­Ø¯Ø©', date:'2025-10-28', hasImage:true},
          {id:1761488503205, title:'Ø¹Ø¯Ù… ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙŠØ§Ù‡', status:'PENDING', inspector:'â€”', contractor:'â€”', date:'2025-10-28', hasImage:false},
          {id:1761488503206, title:'Ø­ÙØ±ÙŠØ© Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚', status:'COMPLETED', inspector:'Ù†ÙˆØ±Ø© Ø§Ù„Ø³Ø¨ÙŠØ¹ÙŠ', contractor:'Ø´Ø±ÙƒØ© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…ØªØ­Ø¯Ø©', date:'2025-10-22', hasImage:true},
        ];
      }
      renderUsers();
      renderObservations();
      renderKPIs();
    }

    // ===== KPIs =====
    function renderKPIs(){
      const total = observations.length;
      const open = observations.filter(o=>o.status!=='COMPLETED').length;
      const closed = total - open;
      const photo = observations.filter(o=>o.hasImage).length;
      document.getElementById('kpi-total').textContent = total;
      document.getElementById('kpi-open').textContent = open;
      document.getElementById('kpi-closed').textContent = closed;
      document.getElementById('kpi-photo').textContent = photo;
      lucide.createIcons();
    }

    // ===== Users =====
    function roleBadge(role){
      const map={manager:'Ù…Ø¯ÙŠØ±', inspector:'Ù…Ø±Ø§Ù‚Ø¨', contractor:'Ù…Ù‚Ø§ÙˆÙ„'};
      const cls={manager:'bg-slate-800 text-white', inspector:'bg-sky-600 text-white', contractor:'bg-emerald-600 text-white'};
      return `<span class="pill ${cls[role]||'bg-gray-400 text-white'}">${map[role]||role}</span>`
    }
    function statusSwitch(u){
      const t = u.active? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„';
      const c = u.active? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700';
      return `<button class="px-3 py-1 text-white rounded-full ${c}" onclick="toggleUser('${u.id}')">${t}</button>`
    }
    function renderUsers(){
      const body = document.getElementById('usersBody');
      const q = (document.getElementById('userSearch').value||'').trim().toLowerCase();
      const filtered = users.filter(u=>!q || u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q));
      if(!filtered.length){ body.innerHTML = `<tr><td colspan=5 class='text-center p-6 text-gray-500'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>`; return; }
      body.innerHTML = filtered.map(u=>
        `<tr>
          <td class="font-bold">${u.name}</td>
          <td>${roleBadge(u.role)}</td>
          <td class="text-gray-600">${u.email}</td>
          <td>${u.active?'<span class="tag bg-green-100 text-green-700">Ù†Ø´Ø·</span>':'<span class="tag bg-red-100 text-red-700">Ù…Ø¹Ø·Ù„</span>'}</td>
          <td class="text-center">
            <div class="flex items-center gap-2 justify-center">
              ${statusSwitch(u)}
              <button class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full" onclick="editUser('${u.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded-full" onclick="removeUser('${u.id}')">Ø­Ø°Ù</button>
            </div>
          </td>
        </tr>`
      ).join('');
      lucide.createIcons();
    }
    function filterUsers(){ renderUsers(); }
    function saveUser(){
      const name=$('#addName').value.trim();
      const email=$('#addEmail').value.trim();
      const role=$('#addRole').value;
      if(!name||!email) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯.');
      users.unshift({id:'u'+(Date.now()), name, email, role, active:true});
      closeModal('modalAddUser');
      $('#addName').value='';$('#addEmail').value='';$('#addRole').value='inspector';
      renderUsers();
    }
    function toggleUser(id){ const u=users.find(x=>x.id===id); if(!u) return; u.active=!u.active; renderUsers(); }
    function editUser(id){ const u=users.find(x=>x.id===id); if(!u) return; const nn=prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…',u.name)||u.name; const em=prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯',u.email)||u.email; u.name=nn; u.email=em; renderUsers(); }
    function removeUser(id){ if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return; users = users.filter(u=>u.id!==id); renderUsers(); }

    // ===== Observations =====
    function renderObservations(){
      const body = document.getElementById('obsBody');
      const f = document.getElementById('statusFilter').value;
      const list = observations.filter(o=> f==='ALL' || o.status===f );
      if(!list.length){ body.innerHTML = `<tr><td colspan=7 class='text-center p-6 text-gray-500'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª</td></tr>`; return; }
      body.innerHTML = list.map(o=>
        `<tr>
          <td class="font-bold">${o.id}</td>
          <td>${o.title}</td>
          <td><span class="tag ${statusColors[o.status]}">${statusLabels[o.status]}</span></td>
          <td>${o.inspector||'â€”'}</td>
          <td>${o.contractor||'â€”'}</td>
          <td class="text-gray-600">${o.date}</td>
          <td class="text-center">
            <div class="flex items-center gap-2 justify-center">
              <button class="px-3 py-1 bg-slate-700 hover:bg-slate-800 text-white rounded-full" onclick="openAssign(${o.id})">ØªØ¹ÙŠÙŠÙ†</button>
              <button class="px-3 py-1 bg-amber-600 hover:bg-amber-700 text-white rounded-full" onclick="cycleStatus(${o.id})">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</button>
              <button class="px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white rounded-full" onclick="closeTicket(${o.id})">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
          </td>
        </tr>`
      ).join('');
      lucide.createIcons();
    }
    function cycleStatus(id){ const o=observations.find(x=>x.id===id); if(!o) return; o.status = o.status==='PENDING'?'IN_PROGRESS':(o.status==='IN_PROGRESS'?'COMPLETED':'PENDING'); renderObservations(); renderKPIs(); }
    function closeTicket(id){ const o=observations.find(x=>x.id===id); if(!o) return; o.status='COMPLETED'; renderObservations(); renderKPIs(); alert('ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº Ø±Ù‚Ù… '+id); }

    // ===== Assign Modal =====
    function openAssign(id){ selectedObservationId=id; const inspSel=$('#assignInspector'); const contSel=$('#assignContractor');
      inspSel.innerHTML = users.filter(u=>u.role==='inspector'&&u.active).map(u=>`<option>${u.name}</option>`).join('');
      contSel.innerHTML = users.filter(u=>u.role==='contractor'&&u.active).map(u=>`<option>${u.name}</option>`).join('');
      openModal('modalAssign');
    }
    function confirmAssign(){ const o=observations.find(x=>x.id===selectedObservationId); if(!o) return; o.inspector=$('#assignInspector').value||o.inspector; o.contractor=$('#assignContractor').value||o.contractor; closeModal('modalAssign'); renderObservations(); alert('ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­'); }

    // ===== Reports (AI Demo) =====
    function generateAiSummary(){
      const total=observations.length; const open=observations.filter(o=>o.status!=='COMPLETED').length; const closed=total-open;
      const topInspector = (function(){ const m={}; observations.forEach(o=>{ if(o.inspector&&o.status==='COMPLETED'){ m[o.inspector]=(m[o.inspector]||0)+1 } }); let k='â€”',v=0; Object.entries(m).forEach(([n,c])=>{ if(c>v){k=n;v=c} }); return k; })();
      const html = `<div class='p-3 border-r-4 border-[--color-teal] bg-white rounded-xl'>
        <p class='font-bold'>Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠ):</p>
        <ul class='list-disc pr-6 mt-2 text-sm text-gray-700'>
          <li>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª: <b>${total}</b> | Ù…ÙØªÙˆØ­Ø©: <b>${open}</b> | Ù…ØºÙ„Ù‚Ø©: <b>${closed}</b>.</li>
          <li>Ø£Ø¹Ù„Ù‰ Ø¥Ù†Ø¬Ø§Ø²: <b>${topInspector}</b> Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ØºÙ„Ù‚Ø©.</li>
          <li>ØªÙˆØµÙŠØ©: ØªØ³Ø±ÙŠØ¹ ØªÙˆØ«ÙŠÙ‚ ØµÙˆØ± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù„Ø±ÙØ¹ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„.</li>
        </ul>
      </div>`;
      const box = document.getElementById('aiSummary');
      box.innerHTML = html; box.classList.remove('hidden');
    }

    // ===== Settings =====
    function toggleDarkMode(){ document.body.classList.toggle('bg-slate-900'); document.body.classList.toggle('text-white'); }

    // ===== Boot =====
    document.getElementById('logoutBtn').addEventListener('click',()=>{
      sessionStorage.removeItem('smartHSRUser');
      sessionStorage.removeItem('welcomed');
      window.location.href='manager-login.html';
    });
    function boot(){ seedDemoData(); lucide.createIcons(); }
    window.addEventListener('DOMContentLoaded', boot);
  </script>
  <!-- Toast -->
  <div id="toast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 bg-teal-600 text-white px-4 py-2 rounded-full shadow-xl z-50 transition-opacity duration-500"></div>
</body>
</html>
