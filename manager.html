<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart HSR | Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± </title>
  <meta name="description" content="Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø¨Ù„Ø§ØºØ§Øª ÙˆÙ…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„Ù†Ø¸Ø§Ù… Smart HSR"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet" />
  <!-- Leaflet (Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø°ÙƒÙŠØ©) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{--color-navy:#0A1931;--color-teal:#18A5A2;--color-gray-bg:#F7F9FC}
    body{font-family:'Tajawal',sans-serif;background:var(--color-gray-bg);color:var(--color-navy)}
    .card{background:#fff;border-radius:1.5rem;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:1.25rem;border-top:5px solid var(--color-teal)}
    .kpi-card{border-radius:1.25rem;color:#fff;padding:1.25rem;display:flex;align-items:center;justify-content:space-between}
    .kpi-open{background:linear-gradient(135deg,#EF4444,#B91C1C)}
    .kpi-closed{background:linear-gradient(135deg,#10B981,#18A5A2)}
    .kpi-total{background:linear-gradient(135deg,#3B82F6,#0A1931)}
    .kpi-photo{background:linear-gradient(135deg,#8B5CF6,#0EA5A1)}
    .btn{background:var(--color-teal);color:#fff;border-radius:999px;padding:.55rem 1.1rem;font-weight:800;transition:.25s;box-shadow:0 6px 15px rgba(24,165,162,.35)}
    .btn:hover{background:#148f8c;transform:translateY(-1px)}
    .btn-ghost{background:#0A1931;color:#fff;border-radius:999px;padding:.55rem 1.1rem;font-weight:800}
    .tag{display:inline-block;border-radius:999px;padding:.2rem .7rem;font-size:.8rem;font-weight:800}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:50;align-items:center;justify-content:center}
    .modal-content{background:#fff;border-radius:1rem;max-width:720px;width:92%;padding:1.25rem;box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .table th,.table td{padding:.75rem;border-bottom:1px solid #e5e7eb}
    .pill{border-radius:999px;padding:.25rem .65rem;font-weight:800}
    .tab-active{background:#fff;border-top:5px solid var(--color-teal);border-radius:1rem 1rem 0 0}

    #map {
  height: 580px;
  border-radius: 20px;
  border: 3px solid transparent;
  background:
    linear-gradient(#fff, #fff) padding-box,
    linear-gradient(135deg, #ACE2E1 0%, #18A5A2 50%, #0A1931 100%) border-box;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  position: relative;
}

    
    .legend{position:absolute;bottom:12px;left:12px;background:#fff;border-radius:.75rem;border:1px solid #e5e7eb;padding:.6rem 1rem;font-size:.85rem;line-height:1.6;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .legend .dot{display:inline-block;width:.8rem;height:.8rem;border-radius:50%;margin-left:.45rem;vertical-align:middle}
    .badge{display:inline-flex;align-items:center;gap:.4rem;background:#F1F5F9;border:1px solid #E2E8F0;padding:.25rem .6rem;border-radius:999px;font-size:.75rem;font-weight:800}
    @media print{.no-print{display:none!important}}
  </style>
</head>
<body>
  <!-- Session Guard + Toast utilities -->
  <script>
    function showToast(msg){
      const t=document.getElementById('toast');
      if(!t) return;
      t.textContent=msg; t.classList.remove('hidden'); t.style.opacity='1';
      setTimeout(()=>{ t.style.opacity='0'; },2200);
      setTimeout(()=>{ t.classList.add('hidden'); },2800);
    }
    (function(){
      const s=sessionStorage.getItem('smartHSRUser');
      if(!s){ window.location.href='manager-login.html'; return; }
      try{
        const user=JSON.parse(s)||{};
        const badge=document.getElementById('userBadge');
        if(badge){ badge.innerHTML = '<i data-lucide="user" class="w-4 h-4"></i> '+(user.email||'Ù…Ø¯ÙŠØ±'); badge.classList.remove('hidden'); }
        if(!sessionStorage.getItem('welcomed')){ showToast('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ â€“ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!'); sessionStorage.setItem('welcomed','1'); }
        try{ lucide.createIcons(); }catch(e){}
        window.__SMART_USER__ = user;
      }catch(e){ console.warn('Session parse failed',e); }
    })();
  </script>

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-40 no-print">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <span class="text-xl font-extrabold">Smart HSR <span class="text-[--color-teal]">Manager Panel</span></span>
      <span id="userBadge" class="hidden md:inline-flex items-center gap-2 bg-teal-50 text-teal-700 px-3 py-1 rounded-full text-xs font-bold"></span>
      <button id="logoutBtn" class="btn-ghost flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <!-- KPIs -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="kpi-card kpi-total"><div><p class="text-sm opacity-90">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p><p id="kpi-total" class="text-4xl font-extrabold">--</p></div><i data-lucide="clipboard-list" class="w-10 h-10 opacity-80"></i></div>
      <div class="kpi-card kpi-open"><div><p class="text-sm opacity-90">Ø¨Ù„Ø§ØºØ§Øª Ù…ÙØªÙˆØ­Ø©</p><p id="kpi-open" class="text-4xl font-extrabold">--</p></div><i data-lucide="alert-triangle" class="w-10 h-10 opacity-80"></i></div>
      <div class="kpi-card kpi-closed"><div><p class="text-sm opacity-90">Ø¨Ù„Ø§ØºØ§Øª Ù…ØºÙ„Ù‚Ø©</p><p id="kpi-closed" class="text-4xl font-extrabold">--</p></div><i data-lucide="check-circle" class="w-10 h-10 opacity-80"></i></div>
      <div class="kpi-card kpi-photo"><div><p class="text-sm opacity-90">Ù…ÙˆØ«Ù‚Ø© Ø¨Ø§Ù„ØµÙˆØ±</p><p id="kpi-photo" class="text-4xl font-extrabold">--</p></div><i data-lucide="image" class="w-10 h-10 opacity-80"></i></div>
    </section>

    <!-- Tabs -->
    <nav class="no-print">
      <ul class="flex gap-3 text-sm font-extrabold">
        <li><button class="px-4 py-2 tab-active" data-tab="users">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</button></li>
        <li><button class="px-4 py-2" data-tab="observations">Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</button></li>
        <li><button class="px-4 py-2" data-tab="map">Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø°ÙƒÙŠØ©</button></li>
        <li><button class="px-4 py-2" data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button></li>
        <li><button class="px-4 py-2" data-tab="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button></li>
      </ul>
    </nav>

    <!-- USERS TAB -->
    <section id="tab-users" class="mt-6">
      <div class="card">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <h2 class="text-2xl font-extrabold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
          <div class="flex items-center gap-2">
            <input id="userSearch" type="text" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯" class="border rounded-xl p-2 w-full md:w-64" oninput="filterUsers()"/>
            <button class="btn" onclick="openModal('modalAddUser')"><i data-lucide="user-plus" class="w-4 h-4 ml-1"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
          </div>
        </div>
        <div class="overflow-x-auto rounded-xl border">
          <table class="table w-full text-sm">
            <thead class="bg-gray-50">
            <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
            </thead>
            <tbody id="usersBody"><tr><td colspan="5" class="text-center p-6 text-gray-500">...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- OBSERVATIONS TAB -->
    <section id="tab-observations" class="mt-6 hidden">
      <div class="card">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <h2 class="text-2xl font-extrabold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h2>
          <div class="flex items-center gap-2">
            <select id="statusFilter" class="border rounded-xl p-2" onchange="renderObservations()">
              <option value="ALL">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
              <option value="PENDING">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
              <option value="IN_PROGRESS">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
              <option value="COMPLETED">Ù…ØºÙ„Ù‚</option>
            </select>
          </div>
        </div>
        <div class="overflow-x-auto rounded-xl border">
          <table class="table w-full text-sm">
            <thead class="bg-gray-50">
            <tr><th>Ø§Ù„Ù…Ø¹Ø±Ù</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨</th><th>Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù„Ø§Øº</th><th class="text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
            </thead>
            <tbody id="obsBody"><tr><td colspan="7" class="text-center p-6 text-gray-500">...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SMART MAP TAB -->
    <section id="tab-map" class="mt-6 hidden">
      <div class="card">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <h2 class="text-2xl font-extrabold">Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø°ÙƒÙŠØ© (Ù…Ø¨Ø§Ø´Ø±)</h2>
          <div class="flex items-center gap-2">
            <span class="badge"><span class="dot" style="background:#ef4444"></span>Ø¬Ø¯ÙŠØ¯</span>
            <span class="badge"><span class="dot" style="background:#f59e0b"></span>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span>
            <span class="badge"><span class="dot" style="background:#10b981"></span>Ù…ØºÙ„Ù‚</span>
            <span class="badge"><span class="dot" style="background:#3b82f6"></span>Ø·Ø§Ù‚Ù… Ù…ÙŠØ¯Ø§Ù†ÙŠ</span>
          </div>
        </div>
        <div id="map"></div>
        <div class="legend">
          <div><span class="dot" style="background:#ef4444"></span>Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
          <div><span class="dot" style="background:#f59e0b"></span>Ù„Ø¯Ù‰ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</div>
          <div><span class="dot" style="background:#10b981"></span>ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
          <div class="mt-2"><span class="dot" style="background:#3b82f6"></span>Ù…ÙˆÙ‚Ø¹ Ù…Ø±Ø§Ù‚Ø¨/Ù…Ù‚Ø§ÙˆÙ„</div>
        </div>
        <div class="flex items-center gap-2 mt-4">
          <button class="btn" id="followMeBtn" onclick="toggleLiveTracking()"><i data-lucide="navigation" class="w-4 h-4 ml-1"></i> ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ÙŠ (ØªØ´ØºÙŠÙ„)</button>
          <button class="btn-ghost" onclick="fitAllMarkers()"><i data-lucide="scan-search" class="w-4 h-4 ml-1"></i> Ù…ÙˆØ§Ø¡Ù…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</button>
        </div>
      </div>
    </section>

    <!-- REPORTS TAB -->
    <section id="tab-reports" class="mt-6 hidden">
      <div class="card">
        <h2 class="text-2xl font-extrabold mb-4">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="p-4 rounded-xl border">
            <h3 class="font-extrabold mb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ (AI Demo)</h3>
            <p class="text-sm text-gray-600 mb-4">Ø§Ø¶ØºØ· Ù„ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ø®Øµ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ±Ù‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©.</p>
            <button class="btn" onclick="generateAiSummary()">âœ¨ ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± ØªÙ†ÙÙŠØ°ÙŠ</button>
            <div id="aiSummary" class="mt-4 text-sm bg-gray-50 rounded-xl p-3 hidden"></div>
          </div>
          <div class="p-4 rounded-xl border">
            <h3 class="font-extrabold mb-2">ØªØµØ¯ÙŠØ± ÙˆØ·Ø¨Ø§Ø¹Ø©</h3>
            <p class="text-sm text-gray-600 mb-4">ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒØªÙ‚Ø±ÙŠØ± PDF.</p>
            <button class="btn-ghost" onclick="window.print()"><i data-lucide="file-down" class="w-4 h-4 ml-1"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS TAB -->
    <section id="tab-settings" class="mt-6 hidden">
      <div class="card">
        <h2 class="text-2xl font-extrabold mb-4">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
        <div class="flex flex-col gap-3">
          <label class="flex items-center gap-2"><input id="darkToggle" type="checkbox" class="w-4 h-4" onchange="toggleDarkMode()"> ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠ)</label>
        </div>
      </div>
    </section>
  </main>

  <!-- MODALS -->
  <div id="modalAddUser" class="modal">
    <div class="modal-content">
      <div class="flex items-center justify-between border-b pb-2 mb-3">
        <h3 class="text-xl font-extrabold">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <button class="text-2xl" onclick="closeModal('modalAddUser')">&times;</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm font-bold">Ø§Ù„Ø§Ø³Ù…</label>
          <input id="addName" class="border rounded-xl p-2 w-full" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯"/>
        </div>
        <div>
          <label class="text-sm font-bold">Ø§Ù„Ø¨Ø±ÙŠØ¯</label>
          <input id="addEmail" type="email" class="border rounded-xl p-2 w-full" placeholder="ahmed@example.com"/>
        </div>
        <div>
          <label class="text-sm font-bold">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="addPassword" type="password" class="border rounded-xl p-2 w-full" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
        </div>
        <div>
          <label class="text-sm font-bold">Ø§Ù„Ø¯ÙˆØ±</label>
          <select id="addRole" class="border rounded-xl p-2 w-full">
            <option value="inspector">Ù…Ø±Ø§Ù‚Ø¨</option>
            <option value="contractor">Ù…Ù‚Ø§ÙˆÙ„</option>
            <option value="manager">Ù…Ø¯ÙŠØ±</option>
          </select>
        </div>
        <div class="md:col-span-2 flex items-end justify-end"><button class="btn" onclick="saveUser()">Ø­ÙØ¸</button></div>
      </div>
    </div>
  </div>

  <div id="modalAssign" class="modal">
    <div class="modal-content">
      <div class="flex items-center justify-between border-b pb-2 mb-3">
        <h3 class="text-xl font-extrabold">ğŸ§­ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ù„Ø§Øº</h3>
        <button class="text-2xl" onclick="closeModal('modalAssign')">&times;</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm font-bold">Ø§Ø®ØªØ± Ù…Ø±Ø§Ù‚Ø¨</label>
          <select id="assignInspector" class="border rounded-xl p-2 w-full"></select>
        </div>
        <div>
          <label class="text-sm font-bold">Ø§Ø®ØªØ± Ù…Ù‚Ø§ÙˆÙ„</label>
          <select id="assignContractor" class="border rounded-xl p-2 w-full"></select>
        </div>
        <div class="flex items-end"><button class="btn" onclick="confirmAssign()">ØªØ¹ÙŠÙŠÙ†</button></div>
      </div>
    </div>
  </div>

  <!-- LIBS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- FIREBASE (Modules) -->
  <script type="module">
    // ------ Firebase setup ------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDocs, addDoc, updateDoc, deleteDoc,
      onSnapshot, serverTimestamp, query, orderBy, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
const firebaseConfig = {
  apiKey: "AIzaSyBfClVxFIXgUXL4olEv5SepUDtzk0dq3lo",
  authDomain: "gen-lang-client-0349944917.firebaseapp.com",
  projectId: "gen-lang-client-0349944917",
  storageBucket: "smart-hsr-manager.firebasestorage.app",
  messagingSenderId: "883065484771",
  appId: "1:883065484771:web:c907bb5a51f68caad75cd6",
  measurementId: "G-V8WG5M8V5B"
};

    let app, db, auth, FIREBASE_READY=false;
    try{
      app  = initializeApp(firebaseConfig);
      db   = getFirestore(app);
      auth = getAuth(app);
      FIREBASE_READY = !!db;
      console.log('âœ… Firebase connected');
    }catch(e){
      console.warn('âš ï¸ Firebase init failed.', e);
    }

    // ===== State =====
    let users = [];
    let observations = [];
    let selectedObservationId = null;

    const statusLabels = { PENDING:'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', IN_PROGRESS:'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', COMPLETED:'Ù…ØºÙ„Ù‚' };
    const statusColors = { PENDING:'bg-red-600 text-white', IN_PROGRESS:'bg-yellow-500 text-black', COMPLETED:'bg-green-600 text-white' };

    // ===== Utils =====
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const openModal = id => { document.getElementById(id).style.display='flex'; }
    const closeModal = id => { document.getElementById(id).style.display='none'; }

    // ===== Tabs =====
    $$("nav [data-tab]").forEach(btn=>{
      btn.addEventListener('click',()=>{
        $$("nav [data-tab]").forEach(b=>b.classList.remove('tab-active'));
        btn.classList.add('tab-active');
        const t = btn.getAttribute('data-tab');
        ['users','observations','map','reports','settings'].forEach(id=>{
          document.getElementById('tab-'+id).classList.toggle('hidden', id!==t);
        });
        if(t==='map'){ setTimeout(()=>{ map?.invalidateSize(); }, 200); }
      })
    });

    // ===== KPIs =====
    function renderKPIs(){
      const total = observations.length;
      const open = observations.filter(o=>o.status!=='COMPLETED').length;
      const closed = total - open;
      const photo = observations.filter(o=>o.hasImage).length;
      document.getElementById('kpi-total').textContent = total;
      document.getElementById('kpi-open').textContent = open;
      document.getElementById('kpi-closed').textContent = closed;
      document.getElementById('kpi-photo').textContent = photo;
      try{ lucide.createIcons(); }catch(e){}
    }

    // ===== Users =====
    function roleBadge(role){
      const map={manager:'Ù…Ø¯ÙŠØ±', inspector:'Ù…Ø±Ø§Ù‚Ø¨', contractor:'Ù…Ù‚Ø§ÙˆÙ„'};
      const cls={manager:'bg-slate-800 text-white', inspector:'bg-sky-600 text-white', contractor:'bg-emerald-600 text-white'};
      return `<span class="pill ${cls[role]||'bg-gray-400 text-white'}">${map[role]||role}</span>`
    }
    function statusSwitch(u){
      const t = u.active? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„';
      const c = u.active? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700';
      return `<button class="px-3 py-1 text-white rounded-full ${c}" onclick="toggleUser('${u.id}')">${t}</button>`
    }
    function renderUsers(){
      const body = document.getElementById('usersBody');
      const q = (document.getElementById('userSearch').value||'').trim().toLowerCase();
      const filtered = users.filter(u=>!q || u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q));
      if(!filtered.length){ body.innerHTML = `<tr><td colspan=5 class='text-center p-6 text-gray-500'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>`; return; }
      body.innerHTML = filtered.map(u=>
        `<tr>
          <td class="font-bold">${u.name}</td>
          <td>${roleBadge(u.role)}</td>
          <td class="text-gray-600">${u.email}</td>
          <td>${u.active?'<span class="tag bg-green-100 text-green-700">Ù†Ø´Ø·</span>':'<span class="tag bg-red-100 text-red-700">Ù…Ø¹Ø·Ù„</span>'}</td>
          <td class="text-center">
            <div class="flex items-center gap-2 justify-center">
              ${statusSwitch(u)}
              <button class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full" onclick="editUser('${u.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded-full" onclick="removeUser('${u.id}')">Ø­Ø°Ù</button>
            </div>
          </td>
        </tr>`
      ).join('');
      try{ lucide.createIcons(); }catch(e){}
    }
    window.filterUsers = ()=>renderUsers();

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ÙØ¹Ù„ÙŠ (Auth + Firestore)
    async function saveUser(){
      const name=$('#addName').value.trim();
      const email=$('#addEmail').value.trim();
      const password=$('#addPassword').value.trim();
      const role=$('#addRole').value;
      if(!name||!email||!password){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.'); return; }
      try{
        if(!FIREBASE_READY){ alert('Ù„Ù… ÙŠØªÙ… Ø¶Ø¨Ø· Firebase Ø¨Ø¹Ø¯. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©.'); return; }
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const uid = cred.user.uid;
        await setDoc(doc(db,'users',uid), { uid, name, email, role, active:true, createdAt: serverTimestamp() });
        users.unshift({ id: uid, name, email, role, active:true });
        closeModal('modalAddUser');
        $('#addName').value=''; $('#addEmail').value=''; $('#addPassword').value=''; $('#addRole').value='inspector';
        renderUsers();
        showToast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
      }catch(err){
        console.error(err); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: '+ (err?.message||err));
      }
    }
    window.saveUser = saveUser;

    async function toggleUser(id){
      const u=users.find(x=>x.id===id); if(!u) return;
      u.active=!u.active; renderUsers();
      if(FIREBASE_READY) await updateDoc(doc(db,'users',id), {active:u.active});
    }
    window.toggleUser = toggleUser;

    async function editUser(id){
      const u=users.find(x=>x.id===id); if(!u) return;
      const nn=prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…',u.name)||u.name;
      const em=prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯',u.email)||u.email;
      u.name=nn; u.email=em; renderUsers();
      if(FIREBASE_READY) await updateDoc(doc(db,'users',id), {name:nn,email:em});
    }
    window.editUser = editUser;

    async function removeUser(id){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
      users = users.filter(u=>u.id!==id); renderUsers();
      if(FIREBASE_READY) await deleteDoc(doc(db,'users',id));
    }
    window.removeUser = removeUser;

    // ===== Observations (Ù‚Ø§Ø¦Ù…Ø©) =====
    function renderObservations(){
      const body = document.getElementById('obsBody');
      const f = document.getElementById('statusFilter').value;
      const list = observations.filter(o=> f==='ALL' || o.status===f );
      if(!list.length){ body.innerHTML = `<tr><td colspan=7 class='text-center p-6 text-gray-500'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª</td></tr>`; return; }
      body.innerHTML = list.map(o=>
        `<tr>
          <td class="font-bold">${o.displayId || o.id}</td>
          <td>${o.title||'â€”'}</td>
          <td><span class="tag ${statusColors[o.status]||'bg-gray-500 text-white'}">${statusLabels[o.status]||o.status}</span></td>
          <td>${o.inspector||'â€”'}</td>
          <td>${o.contractor||'â€”'}</td>
          <td class="text-gray-600">${o.date||'â€”'}</td>
<td class="text-center">
  <div class="flex items-center gap-2 justify-center">
    <button class="px-3 py-1 bg-slate-700 hover:bg-slate-800 text-white rounded-full" onclick="openAssign('${o.docId||o.id}')">ØªØ¹ÙŠÙŠÙ†</button>
    <button class="px-3 py-1 bg-amber-600 hover:bg-amber-700 text-white rounded-full" onclick="cycleStatus('${o.docId||o.id}')">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</button>
    <button class="px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white rounded-full" onclick="closeTicket('${o.docId||o.id}')">Ø¥ØºÙ„Ø§Ù‚</button>

    <!-- ğŸ”´ Ø²Ø± Ø§Ù„Ø­Ø°Ù -->
    <button class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-full" onclick="deleteObservation('${o.docId||o.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>

    <!-- ğŸ”µ Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± -->
    <button class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full" onclick="showObservationImages('${o.docId||o.id}')">ğŸ“¸ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±</button>
  </div>
</td>

        </tr>`
      ).join('');
      try{ lucide.createIcons(); }catch(e){}
    }
    window.renderObservations = renderObservations;

    async function cycleStatus(id){
      const o=observations.find(x=>(x.docId||x.id)==id); if(!o) return;
      o.status = o.status==='PENDING'?'IN_PROGRESS':(o.status==='IN_PROGRESS'?'COMPLETED':'PENDING');
      renderObservations(); renderKPIs(); refreshMapMarkers();
      if(FIREBASE_READY && o.docId) await updateDoc(doc(db,'observations',o.docId), {status:o.status});
    }
    window.cycleStatus = cycleStatus;

    async function closeTicket(id){
      const o=observations.find(x=>(x.docId||x.id)==id); if(!o) return;
      o.status='COMPLETED'; renderObservations(); renderKPIs(); refreshMapMarkers();
      if(FIREBASE_READY && o.docId) await updateDoc(doc(db,'observations',o.docId), {status:'COMPLETED', closedAt: serverTimestamp()});
      alert('ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº Ø±Ù‚Ù… '+(o.displayId || o.id));
    }
    window.closeTicket = closeTicket;

    // ===== Assign Modal =====
    function openAssign(id){
      selectedObservationId=id;
      const inspSel=$('#assignInspector'); const contSel=$('#assignContractor');
      const insp = users.filter(u=>u.role==='inspector'&&u.active);
      const cont = users.filter(u=>u.role==='contractor'&&u.active);
      inspSel.innerHTML = insp.length? insp.map(u=>`<option>${u.name}</option>`).join('') : '<option disabled>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø§Ù‚Ø¨ÙˆÙ† Ù†Ø´Ø·ÙˆÙ†</option>';
      contSel.innerHTML = cont.length? cont.map(u=>`<option>${u.name}</option>`).join('') : '<option disabled>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ† Ù†Ø´Ø·ÙˆÙ†</option>';
      openModal('modalAssign');
    }
    window.openAssign = openAssign;

    async function confirmAssign(){
      const o=observations.find(x=>(x.docId||x.id)==selectedObservationId); if(!o) return;
      const inspector=$('#assignInspector').value||o.inspector;
      const contractor=$('#assignContractor').value||o.contractor;
      o.inspector=inspector; o.contractor=contractor;
      closeModal('modalAssign'); renderObservations();
      if(FIREBASE_READY && o.docId) await updateDoc(doc(db,'observations',o.docId), {inspector,contractor});
      alert('ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
    }
    window.confirmAssign = confirmAssign;

    // ===== Reports (AI Demo) =====
    function generateAiSummary(){
      const total=observations.length; const open=observations.filter(o=>o.status!=='COMPLETED').length; const closed=total-open;
      const topInspector = (function(){ const m={}; observations.forEach(o=>{ if(o.inspector&&o.status==='COMPLETED'){ m[o.inspector]=(m[o.inspector]||0)+1 } }); let k='â€”',v=0; Object.entries(m).forEach(([n,c])=>{ if(c>v){k=n;v=c} }); return k; })();
      const html = `<div class='p-3 border-r-4 border-[--color-teal] bg-white rounded-xl'>
        <p class='font-bold'>Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠ):</p>
        <ul class='list-disc pr-6 mt-2 text-sm text-gray-700'>
          <li>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª: <b>${total}</b> | Ù…ÙØªÙˆØ­Ø©: <b>${open}</b> | Ù…ØºÙ„Ù‚Ø©: <b>${closed}</b>.</li>
          <li>Ø£Ø¹Ù„Ù‰ Ø¥Ù†Ø¬Ø§Ø²: <b>${topInspector}</b> Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ØºÙ„Ù‚Ø©.</li>
          <li>ØªÙˆØµÙŠØ©: ØªØ³Ø±ÙŠØ¹ ØªÙˆØ«ÙŠÙ‚ ØµÙˆØ± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù„Ø±ÙØ¹ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„.</li>
        </ul>
      </div>`;
      const box = document.getElementById('aiSummary');
      box.innerHTML = html; box.classList.remove('hidden');
    }
    window.generateAiSummary = generateAiSummary;

    // ===== Settings =====
    function toggleDarkMode(){ document.body.classList.toggle('bg-slate-900'); document.body.classList.toggle('text-white'); }
    window.toggleDarkMode = toggleDarkMode;

    // ===== Logout =====
    document.getElementById('logoutBtn').addEventListener('click',()=>{
      sessionStorage.removeItem('smartHSRUser');
      sessionStorage.removeItem('welcomed');
      window.location.href='manager-login.html';
    });

    // ===== Firestore sync (Users + Observations) =====
    async function loadFromFirestore(){
      if(!FIREBASE_READY) { console.warn('Firebase ØºÙŠØ± Ù…ØªØ§Ø­ â€” Ù„Ù† ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.'); return; }

      // Users
      onSnapshot(collection(db,'users'), snap=>{
        users = [];
        snap.forEach(d=> users.push({id:d.id, ...d.data()}) );
        renderUsers();
      });

      // Observations ordered by time desc
      onSnapshot(query(collection(db,'observations'), orderBy('createdAt','desc')), snap=>{
        const arr=[];
        snap.forEach(d=>{
          const x=d.data();
          // Ø¯Ø¹Ù… ÙƒÙ„Ø§ Ø§Ù„Ø­Ø§Ù„ØªÙŠÙ†: lat/lng ÙƒØ£Ø±Ù‚Ø§Ù… Ø£Ùˆ location ÙƒÙ†Øµ "lat, lng"
          let lat = typeof x.lat==='number' ? x.lat : null;
          let lng = typeof x.lng==='number' ? x.lng : null;
          if((lat===null || lng===null) && typeof x.location==='string'){
            const parts = x.location.split(',').map(s=>parseFloat(s.trim()));
            if(parts.length===2 && parts.every(n=>Number.isFinite(n))){ lat=parts[0]; lng=parts[1]; }
          }
          arr.push({
            docId:d.id,
            id: x.id || d.id,
            displayId: x.displayId || x.id || '',
            title: x.title || '',
            status: x.status || 'PENDING',
            inspector: x.inspector || 'â€”',
            contractor: x.contractor || 'â€”',
            date: x.date || '',
            hasImage: !!(x.imagePath || x.afterImagePath),
            lat, lng
          });
        });
        observations = arr;
        renderObservations(); renderKPIs(); refreshMapMarkers();
      });
    }

    // ===== Smart Map (Leaflet) =====
    let map, markersLayer, presenceLayer, myWatchId=null, presenceUnsub=null;
    const statusColor = s => s==='PENDING' ? '#ef4444' : (s==='IN_PROGRESS' ? '#f59e0b' : '#10b981');

    function initMap(){
      map = L.map('map',{ zoomControl:true }).setView([24.7136,46.6753], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      presenceLayer = L.layerGroup().addTo(map);
    }

    function makeDot(color){
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28">
          <circle cx="14" cy="14" r="10" fill="${color}" stroke="white" stroke-width="3"/>
        </svg>`;
      return L.icon({
        iconUrl: 'data:image/svg+xml;base64,'+btoa(svg),
        iconSize:[28,28], iconAnchor:[14,14], popupAnchor:[0,-12]
      });
    }
    const ICONS = {
      PENDING: makeDot('#ef4444'),
      IN_PROGRESS: makeDot('#f59e0b'),
      COMPLETED: makeDot('#10b981'),
      CREW: makeDot('#3b82f6')
    };

    function refreshMapMarkers(){
      if(!map) return;
      markersLayer.clearLayers();
      const list = observations.filter(o=>Number.isFinite(o.lat) && Number.isFinite(o.lng));
      list.forEach(o=>{
        const icon = ICONS[o.status] || ICONS.PENDING;
        const m = L.marker([o.lat,o.lng], {icon})

         .bindPopup(`
  <div style="min-width:200px; font-family:Tajawal;">
    <div class="font-extrabold mb-1 text-[15px]">${o.title || 'â€”'}</div>
    <div class="text-xs text-gray-600 mb-2">Ø§Ù„Ù…Ø¹Ø±Ù: ${(o.displayId || o.id) || 'â€”'}</div>
    <div class="text-xs mb-2"><span class="badge"><span class="dot" style="background:${statusColor(o.status)}"></span>${statusLabels[o.status] || o.status}</span></div>
    ${o.inspector && o.inspector !== 'â€”' ? `<div class="text-xs mb-1">ğŸ‘·â€â™‚ï¸ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨: ${o.inspector}</div>` : ''}
    ${o.contractor && o.contractor !== 'â€”' ? `<div class="text-xs mb-2">ğŸ—ï¸ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„: ${o.contractor}</div>` : ''}
    <div class="flex flex-col gap-2">
      <button onclick="showObservationImages('${o.docId || o.id}')" class="px-2 py-1 bg-indigo-600 text-white rounded text-xs w-full">ğŸ“¸ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±</button>
      <button onclick="closeTicket('${o.docId || o.id}')" class="px-2 py-1 bg-green-600 text-white rounded text-xs w-full">âœ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº</button>
      <button onclick="deleteObservation('${o.docId || o.id}')" class="px-2 py-1 bg-red-600 text-white rounded text-xs w-full">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº</button>
    </div>
  </div>
`);
 

        
        m.addTo(markersLayer);
      });
    }

    function fitAllMarkers(){
      const all = [];
      markersLayer.eachLayer(l=> all.push(l.getLatLng()));
      presenceLayer.eachLayer(l=> all.push(l.getLatLng()));
      if(!all.length) return;
      const bounds = L.latLngBounds(all);
      map.fitBounds(bounds.pad(0.2));
    }
    window.fitAllMarkers = fitAllMarkers;

    async function toggleLiveTracking(){
      const btn = document.getElementById('followMeBtn');
      if(myWatchId!==null){
        navigator.geolocation.clearWatch(myWatchId);
        myWatchId=null; btn.textContent='ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ÙŠ (ØªØ´ØºÙŠÙ„)';
        showToast('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹');
        return;
      }
      if(!('geolocation' in navigator)){ alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS'); return; }
      btn.textContent='Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹';
      myWatchId = navigator.geolocation.watchPosition(async pos=>{
        const {latitude:lat, longitude:lng} = pos.coords;
        if(FIREBASE_READY){
          const me = window.__SMART_USER__ || {};
          await setDoc(doc(db,'presence', (me.email||'manager')), {
            role: 'manager', email: me.email||'manager', lat, lng, updatedAt: serverTimestamp()
          });
        }
      }, _err=>{
        console.warn(_err); showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
      }, {enableHighAccuracy:true, maximumAge:5000, timeout:20000});
    }
    window.toggleLiveTracking = toggleLiveTracking;

    function subscribePresence(){
      if(!FIREBASE_READY) return;
      if(presenceUnsub) presenceUnsub();
      presenceUnsub = onSnapshot(collection(db,'presence'), snap=>{
        presenceLayer.clearLayers();
        snap.forEach(d=>{
          const p=d.data(); if(typeof p.lat!=='number'||typeof p.lng!=='number') return;
          const m = L.marker([p.lat,p.lng], {icon:ICONS.CREW})
            .bindPopup(`<div class="text-sm"><b>${p.role||'crew'}</b><div class="text-xs text-gray-600">${p.email||''}</div></div>`);
          m.addTo(presenceLayer);
        });
      });
    }

    // ===== Boot =====
    function boot(){
      initMap();
      if(FIREBASE_READY) { loadFromFirestore(); subscribePresence(); }
      else { showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¶Ø¨Ø· Ù…ÙØ§ØªÙŠØ­ Firebase Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.'); }
      try{ lucide.createIcons(); }catch(e){}
    }
    window.addEventListener('DOMContentLoaded', boot);

  
    
        // ===== Delete Observation =====
    async function deleteObservation(id) {
      if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ")) return;
      const o = observations.find(x => (x.docId || x.id) == id);
      if (!o) return;

      // Ø­Ø°Ù Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      observations = observations.filter(x => (x.docId || x.id) != id);
      renderObservations();
      renderKPIs();
      refreshMapMarkers?.();

      // Ø­Ø°Ù Ù…Ù† Firestore
      if (FIREBASE_READY && o.docId) {
        try {
          await deleteDoc(doc(db, "observations", o.docId));
          alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ù†Ø¬Ø§Ø­");
        } catch (err) {
          console.error(err);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù âŒ");
        }
      }
    }
    window.deleteObservation = deleteObservation;


// ===== Show Observation Images (Ø®Ø±ÙŠØ·Ø© Ø°ÙƒÙŠØ© Ù…Ø·ÙˆØ±Ø©) =====
async function showObservationImages(id) {
  const o = observations.find(x => (x.docId || x.id) == id);
  if (!o) {
    alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.");
    return;
  }

  // Ø¬Ù…Ø¹ Ø§Ù„ØµÙˆØ± Ù…Ù† ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
  const keys = [
    "beforeImagePath", "afterImagePath", "imagePath",
    "beforeImage", "afterImage", "photoPath", "imgPath", "photoUrl"
  ];
  let before = null, after = null;
  for (const key of keys) {
    if (o[key] && typeof o[key] === "string") {
      if (!before) before = o[key];
      else if (!after && o[key] !== before) after = o[key];
    }
  }
  if (o.images) {
    if (o.images.before && !before) before = o.images.before;
    if (o.images.after && !after) after = o.images.after;
  }

  // Ù„Ùˆ Ù…Ø§ÙÙŠÙ‡ ØµÙˆØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
  if (!before && !after) {
    L.popup()
      .setLatLng([o.lat, o.lng])
      .setContent(`<div style="min-width:220px;text-align:center;font-family:Tajawal;">
        ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…Ø±ÙÙ‚Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.
      </div>`)
      .openOn(map);
    return;
  }

  // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
  const html = `
    <div style="position:relative;width:270px;overflow:hidden;border-radius:12px;">
      <img src="${before}" style="width:100%;display:block;border-radius:12px;">
      ${
        after
          ? `<div id="compareAfter" style="position:absolute;top:0;left:0;width:50%;overflow:hidden;">
               <img src="${after}" style="width:100%;border-radius:12px;">
             </div>
             <div id="compareDivider" style="position:absolute;top:0;left:50%;width:3px;height:100%;background:#18A5A2;cursor:ew-resize;"></div>`
          : ""
      }
      <div style="text-align:center;margin-top:5px;">
        <small>${after ? "ğŸ“¸ Ù‚Ø¨Ù„ / Ø¨Ø¹Ø¯" : "ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ø¨Ù„Ø§Øº"}</small>
      </div>
    </div>
  `;

  // ÙØªØ­ Ø§Ù„Ø¨ÙˆØ¨ Ø£Ø¨
  const popup = L.popup()
    .setLatLng([o.lat, o.lng])
    .setContent(html)
    .openOn(map);

  // Ù„Ùˆ ÙÙŠ ØµÙˆØ±ØªÙŠÙ† â€” ÙØ¹Ù„ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠØ¯ÙˆÙŠ
  setTimeout(() => {
    const divider = document.getElementById("compareDivider");
    const afterBox = document.getElementById("compareAfter");
    if (!divider || !afterBox) return;
    let dragging = false;
    divider.addEventListener("mousedown", () => (dragging = true));
    window.addEventListener("mouseup", () => (dragging = false));
    window.addEventListener("mousemove", e => {
      if (!dragging) return;
      const rect = divider.parentElement.getBoundingClientRect();
      let x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
      const percent = (x / rect.width) * 100;
      afterBox.style.width = percent + "%";
      divider.style.left = percent + "%";
    });
  }, 300);
}
window.showObservationImages = showObservationImages;

// ===== CSS Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù†Ø§ÙØ°Ø© =====
const style = document.createElement("style");
style.textContent = `
.observation-modal {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}
.modal-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(4px);
  animation: fadeIn 0.3s ease;
}
.modal-content {
  background: #fff;
  border-radius: 18px;
  padding: 24px;
  max-width: 90%;
  max-height: 90%;
  overflow: auto;
  text-align: center;
  z-index: 10;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  animation: scaleIn 0.25s ease;
}
.modal-content h3 {
  font-size: 20px;
  color: #0b2b3a;
  font-weight: 800;
  margin-bottom: 16px;
}
.images {
  display: flex;
  gap: 20px;
  justify-content: center;
  flex-wrap: wrap;
}
.images div p {
  font-weight: bold;
  color: #0ea5a1;
  margin-bottom: 6px;
}
.images img {
  max-width: 280px;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.25);
  transition: transform 0.3s ease;
  cursor: zoom-in;
}
.images img:hover {
  transform: scale(1.05);
}
.modal-content button {
  background: linear-gradient(90deg,#0b2b3a,#0ea5a1);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 22px;
  margin-top: 20px;
  font-weight: bold;
  cursor: pointer;
  transition: opacity 0.3s ease;
}
.modal-content button:hover { opacity: 0.85; }
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
@keyframes scaleIn { from{opacity:0;transform:scale(.9);} to{opacity:1;transform:scale(1);} }
`;
document.head.appendChild(style);


    
  </script>

  <!-- App helpers (non-module so we can call them from inline HTML) -->
  <script>
    window.openModal = (id)=>{ document.getElementById(id).style.display='flex'; };
    window.closeModal = (id)=>{ document.getElementById(id).style.display='none'; };
  </script>

<!-- Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØµÙˆØ± Ù‚Ø¨Ù„ ÙˆØ¨Ø¹Ø¯ -->
<div id="imageComparisonWrapper" class="comparison-wrapper hidden mt-6">
  <img id="beforeImage" class="before-image w-full h-auto" alt="ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­">
  <div id="afterImageContainer" class="after-image">
    <img id="afterImage" class="w-full h-auto" alt="ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­">
  </div>
  <div id="comparisonDivider" class="comparison-divider no-print">
    <div class="comparison-divider-handle">
      <i data-lucide="arrow-left-right" class="w-4 h-4 text-teal-600"></i>
    </div>
  </div>
  <span class="comparison-label label-before no-print">Ù‚Ø¨Ù„</span>
  <span class="comparison-label label-after no-print">Ø¨Ø¹Ø¯</span>
</div>

  
  <!-- Toast -->
  <div id="toast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 bg-teal-600 text-white px-4 py-2 rounded-full shadow-xl z-50 transition-opacity duration-500"></div>


</body>
</html>
